<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Escuela Sab√°tica V57 - Super Detector</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root { --bg:#fff; --text:#222; --primary:#00695c; --sec:#e0f2f1; --acc:#c62828; --ribbon:#333; }
        body.sepia { --bg:#f4ecd8; --text:#5b4636; --primary:#5d4037; --sec:#eefebe; }
        body.dark { --bg:#121212; --text:#e0e0e0; --primary:#80cbc4; --sec:#1e1e1e; --acc:#ef9a9a; --ribbon:#eee; }
        body.amber { --bg:#000000; --text:#ffb74d; --primary:#e65100; --sec:#1a1a1a; }

        body { font-family:'Georgia',serif; margin:0; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; }
        
        header { background:var(--sec); padding:8px; border-bottom:2px solid var(--primary); display:flex; gap:5px; align-items:center; z-index:50; flex-shrink:0; }
        select { flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; background:var(--bg); color:var(--text); font-size:16px; }
        .tool-btn { background:none; border:1px solid transparent; padding:6px; cursor:pointer; border-radius:4px; color:var(--text); font-weight:bold; }

        #workspace { display:flex; flex:1; overflow:hidden; position:relative; }
        #main-container { flex:1; overflow-y:auto; padding:20px 50px; box-sizing:border-box; outline:none; }
        @media(max-width:600px){ #main-container{padding:15px;} }

        .nav-arrow { position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.05); border:none; color:var(--text); font-size:2rem; padding:20px 5px; cursor:pointer; z-index:40; border-radius:5px; }
        .nav-arrow:hover { background:var(--primary); color:var(--bg); }
        #prev-btn { left:0; } #next-btn { right:0; }

        h1 { color:var(--primary); border-bottom:1px solid #ccc; font-size:1.5em; }
        h2 { color:var(--text); margin-top:25px; font-weight:bold; font-size:1.2em; }
        h3 { color:var(--acc); margin-top:15px; font-size:1.1em; }
        p { line-height:1.8; font-size:1.15em; margin-bottom:15px; }
        
        /* ENLACES B√çBLICOS REFORZADOS */
        .bible-link { color:var(--primary); font-weight:bold; text-decoration:underline; cursor:pointer; padding:2px 4px; background:rgba(0,105,92,0.1); border-radius:4px; }
        .bible-link:hover { background:var(--primary); color:white; }

        .note-sup { font-size:0.7em; vertical-align:super; cursor:pointer; color:var(--acc); text-decoration:none; border:none; font-weight:bold; margin-left:2px; }
        .note-sup::before { content:'‚úé'; }

        .question-label { display:block; font-family:sans-serif; font-weight:bold; color:var(--acc); margin-top:10px; font-size:0.9em; }
        .rich-box { width:100%; min-height:100px; padding:10px; margin:5px 0 15px 0; border:1px solid #999; border-radius:5px; background:var(--bg); color:var(--text); font-family:sans-serif; overflow-y:auto; outline:none; }
        .rich-box img { max-width:100%; display:block; margin:5px 0; border-radius:4px; }

        #ribbon { position:absolute; display:none; background:var(--ribbon); padding:8px; border-radius:8px; box-shadow:0 5px 20px rgba(0,0,0,0.5); z-index:2000; flex-direction:column; gap:6px; min-width:260px; }
        body.dark #ribbon { background:#eee; }
        .rib-row { display:flex; align-items:center; gap:5px; overflow-x:auto; }
        .swatch { width:24px; height:24px; border:1px solid #fff; cursor:pointer; flex-shrink:0; position:relative; overflow:hidden; }
        .swatch input { position:absolute; top:-50%; left:-50%; width:200%; height:200%; opacity:0; cursor:pointer; }
        .rib-btn { background:#555; color:white; border:none; padding:6px; border-radius:4px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        body.dark .rib-btn { background:#ccc; color:#000; }

        /* VENTANAS FLOTANTES */
        .float-win { position:absolute; top:20%; left:20%; width:400px; height:300px; background:var(--bg); border:1px solid #999; box-shadow:0 10px 40px rgba(0,0,0,0.5); z-index:3000; display:none; flex-direction:column; resize:both; overflow:hidden; border-radius:8px; min-width:250px; min-height:200px; }
        .win-head { padding:8px 10px; background:var(--primary); color:white; cursor:move; display:flex; justify-content:space-between; align-items:center; user-select:none; }
        .win-body { flex:1; padding:10px; overflow:auto; display:flex; flex-direction:column; color:var(--text); }
        .win-foot { padding:10px; background:var(--sec); border-top:1px solid #ccc; display:flex; gap:10px; justify-content:flex-end; }

        #login-screen { position:fixed; inset:0; background:var(--bg); z-index:5000; display:flex; align-items:center; justify-content:center; }
        .login-box { text-align:center; padding:30px; border:1px solid #ccc; border-radius:10px; width:300px; background:var(--sec); }
        .login-inp { width:100%; padding:10px; margin:10px 0; border:1px solid #999; border-radius:4px; box-sizing:border-box; }

        .hidden { display:none!important; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--primary)">Mi Estudio</h2>
            <input id="email" class="login-inp" type="email" placeholder="Email">
            <input id="pass" class="login-inp" type="password" placeholder="Contrase√±a">
            <button onclick="auth.login()" style="width:100%; padding:10px; background:var(--primary); color:white; border:none; margin-top:10px; cursor:pointer">Entrar</button>
            <button onclick="auth.reg()" style="width:100%; padding:10px; background:#555; color:white; border:none; margin-top:5px; cursor:pointer">Registrar</button>
            <p id="msg" style="color:red; font-size:0.8rem; margin-top:10px"></p>
        </div>
    </div>

    <div id="app" class="hidden">
        <header>
            <select id="sel-q" onchange="nav.changeQuarter()"></select>
            <select id="sel-l" onchange="nav.changeLesson()"></select>
            <select id="sel-d" onchange="loader.load()"></select>
            <button class="tool-btn" onclick="ui.cycleMode()">üé®</button>
            <button class="tool-btn" onclick="ui.font(2)">A+</button>
            <button class="tool-btn" onclick="ui.font(-2)">A-</button>
            <button class="tool-btn" onclick="loader.resetDay()" style="color:red">üóëÔ∏è</button>
        </header>

        <div id="workspace">
            <button id="prev-btn" class="nav-arrow" onclick="nav.prev()">‚ùÆ</button>
            <button id="next-btn" class="nav-arrow" onclick="nav.next()">‚ùØ</button>

            <div id="main-container" onmouseup="ribbon.show()" ontouchend="ribbon.show()">
                <div id="content">
                    <p style="text-align:center; margin-top:50px">Cargando...</p>
                </div>
            </div>

            <!-- NOTAS -->
            <div id="note-window" class="float-win" style="top:20%; left:20%;">
                <div class="win-head" onmousedown="dragElement(document.getElementById('note-window'), event)">
                    <span>üìù Nota</span> <span onclick="notes.close()" style="cursor:pointer">‚úï</span>
                </div>
                <div class="win-body">
                    <div style="font-size:0.8em; opacity:0.7; margin-bottom:5px">Pega im√°genes (Ctrl+V).</div>
                    <div id="window-editor" class="rich-box" contenteditable="true" style="flex:1; margin:0; border:1px solid #ccc"></div>
                </div>
                <div class="win-foot">
                    <button onclick="notes.delete()" style="background:var(--acc); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer">Eliminar</button>
                    <button onclick="notes.save()" style="background:var(--primary); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer">Guardar</button>
                </div>
            </div>

            <!-- BIBLIA -->
            <div id="bible-window" class="float-win" style="top:15%; left:15%; width:400px;">
                <div class="win-head" onmousedown="dragElement(document.getElementById('bible-window'), event)">
                    <span id="bible-title">Biblia</span> <span onclick="document.getElementById('bible-window').style.display='none'" style="cursor:pointer">‚úï</span>
                </div>
                <div class="win-body">
                    <div id="bible-content" style="line-height:1.6; font-size:1.1em; padding:10px;">Cargando...</div>
                    <div style="margin-top:20px; text-align:center">
                        <a id="bible-ext-link" href="#" target="_blank" style="display:inline-block; padding:8px; background:var(--primary); color:white; text-decoration:none; border-radius:5px; font-size:0.9rem">üìñ Abrir Externo</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="ribbon" onmousedown="event.preventDefault()">
            <div class="rib-row">
                <span style="font-size:10px; color:#999">FONDO</span>
                <div class="swatch" style="background:#ffff00" onclick="tools.bg('#ffff00')"></div>
                <div class="swatch" style="background:#a5d6a7" onclick="tools.bg('#a5d6a7')"></div>
                <div class="swatch" style="background:#90caf9" onclick="tools.bg('#90caf9')"></div>
                <div class="swatch" style="background:conic-gradient(red,blue,green)"><input type="color" oninput="tools.bg(this.value)"></div>
                <button class="rib-btn" onclick="tools.bg('transparent')">üö´</button>
            </div>
            <div class="rib-row">
                <span style="font-size:10px; color:#999">LETRA</span>
                <div class="swatch" style="background:#000" onclick="tools.fg('#000')"></div>
                <div class="swatch" style="background:#c62828" onclick="tools.fg('#c62828')"></div>
                <div class="swatch" style="background:#1565c0" onclick="tools.fg('#1565c0')"></div>
                <div class="swatch" style="background:conic-gradient(black,white)"><input type="color" oninput="tools.fg(this.value)"></div>
            </div>
            <div class="rib-row" style="border-top:1px solid #555; padding-top:5px; justify-content:space-between">
                <div style="display:flex; gap:3px">
                    <button class="rib-btn" onclick="tools.exec('bold')"><b>B</b></button>
                    <button class="rib-btn" onclick="tools.exec('italic')"><i>I</i></button>
                    <button class="rib-btn" onclick="tools.exec('underline')"><u>U</u></button>
                    <button class="rib-btn" onclick="tools.clear()">üßπ</button>
                </div>
                <button class="rib-btn" onclick="tools.addNote()" style="background:var(--primary)">üìù</button>
                <button class="rib-btn" onclick="ribbon.hide()">‚úï</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyD8Z79dXBAIYXYYm-hvyJZszGiTiX1cdLk", authDomain: "miescuelasabatica-fdb06.firebaseapp.com", databaseURL: "https://miescuelasabatica-fdb06-default-rtdb.firebaseio.com", projectId: "miescuelasabatica-fdb06", storageBucket: "miescuelasabatica-fdb06.firebasestorage.app", messagingSenderId: "832420279762", appId: "1:832420279762:web:4218b0fa30e2e93b12c40b" };
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const fbDb = firebase.database();
        fbAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        const state = { user: null, q: '2025-04', l: '01', d: '01', activeNoteId: null };

        const auth = {
            login: () => fbAuth.signInWithEmailAndPassword(val('email'), val('pass')).catch(e=>msg(e.message)),
            reg: () => fbAuth.createUserWithEmailAndPassword(val('email'), val('pass')).catch(e=>msg(e.message))
        };
        function val(id){ return document.getElementById(id).value; }
        function msg(t){ document.getElementById('msg').innerText = t; }

        fbAuth.onAuthStateChanged(u => {
            if(u){
                state.user = u;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                nav.init();
            }
        });

        function dragElement(elm, e) {
            e.preventDefault(); let pos3=e.clientX, pos4=e.clientY;
            document.onmouseup = closeDragElement; document.onmousemove = elementDrag;
            function elementDrag(e) { e.preventDefault(); let pos1=pos3-e.clientX, pos2=pos4-e.clientY; pos3=e.clientX; pos4=e.clientY; elm.style.top=(elm.offsetTop-pos2)+"px"; elm.style.left=(elm.offsetLeft-pos1)+"px"; }
            function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
        }

        const nav = {
            init: () => {
                const qSel = document.getElementById('sel-q');
                qSel.add(new Option("Josu√© (2025-04)", "2025-04"));
                qSel.add(new Option("√âxodo (2025-03)", "2025-03"));
                const lSel = document.getElementById('sel-l');
                for(let i=1; i<=14; i++) lSel.add(new Option("Lecci√≥n "+i, i<10?"0"+i:""+i));
                const dSel = document.getElementById('sel-d');
                ['S√°bado','Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes'].forEach((d,i) => dSel.add(new Option(d, "0"+(i+1))));
                dSel.add(new Option("--- Extras ---", "disabled", true, true));
                dSel.add(new Option("Maestros", "08")); dSel.add(new Option("Misionero", "09"));
                
                document.getElementById('sel-l').value = "09"; 
                document.getElementById('sel-d').value = "0" + (new Date().getDay()||7);
                loader.load();
            },
            changeQuarter: () => { state.q = document.getElementById('sel-q').value; loader.load(); },
            changeLesson: () => { state.l = document.getElementById('sel-l').value; loader.load(); },
            prev: () => { let s=document.getElementById('sel-d'); if(s.selectedIndex>0){s.selectedIndex--; if(s.value==='disabled')s.selectedIndex--; loader.load();} },
            next: () => { let s=document.getElementById('sel-d'); if(s.selectedIndex<s.options.length-1){s.selectedIndex++; if(s.value==='disabled')s.selectedIndex++; loader.load();} }
        };

        const loader = {
            load: async () => {
                ribbon.hide(); notes.close();
                state.q = document.getElementById('sel-q').value; state.l = document.getElementById('sel-l').value; state.d = document.getElementById('sel-d').value;
                if(state.d==='disabled') return;
                document.getElementById('content').innerHTML = '<p style="text-align:center; padding:50px">Cargando...</p>';
                
                fbDb.ref(`users/${state.user.uid}/pages/${state.q}-${state.l}-${state.d}`).once('value', async (s) => {
                    if(s.val()) {
                        document.getElementById('content').innerHTML = s.val();
                        loader.postLoad();
                    } else {
                        await loader.fetchGitHub();
                    }
                });
            },
            fetchGitHub: async () => {
                const url = `https://raw.githubusercontent.com/Adventech/sabbath-school-lessons/master/src/es/${state.q}/${state.l}/${state.d}.md`;
                try {
                    let r = await fetch(url); if(!r.ok) throw new Error();
                    let md = await r.text();
                    document.getElementById('content').innerHTML = parser(md);
                    loader.postLoad();
                } catch(e) { document.getElementById('content').innerHTML = "<p>Contenido no disponible.</p>"; }
            },
            postLoad: () => {
                document.querySelectorAll('.bible-link').forEach(e => e.onclick = () => bible.fetch(e.innerText));
                document.querySelectorAll('.note-marker').forEach(e => e.onclick = (ev) => { ev.stopPropagation(); notes.open(e.dataset.id); });
                enablePasteImage();
                loader.restoreInputs();
            },
            save: () => fbDb.ref(`users/${state.user.uid}/pages/${state.q}-${state.l}-${state.d}`).set(document.getElementById('content').innerHTML),
            resetDay: () => { if(confirm("¬øReiniciar?")) { fbDb.ref(`users/${state.user.uid}/pages/${state.q}-${state.l}-${state.d}`).remove(); fbDb.ref(`users/${state.user.uid}/inputs/${state.q}-${state.l}-${state.d}`).remove(); loader.load(); } },
            saveInput: (id, val) => fbDb.ref(`users/${state.user.uid}/inputs/${state.q}-${state.l}-${state.d}/${id}`).set(val),
            restoreInputs: () => fbDb.ref(`users/${state.user.uid}/inputs/${state.q}-${state.l}-${state.d}`).once('value', s => { if(s.val()) Object.keys(s.val()).forEach(k => { let el=document.getElementById(k); if(el) el.innerHTML=s.val()[k]; }); })
        };

        function enablePasteImage() {
            const h = (e) => {
                let items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let i in items) {
                    if (items[i].kind === 'file') {
                        let blob = items[i].getAsFile();
                        let r = new FileReader();
                        r.onload = (evt) => { document.execCommand('insertImage', false, evt.target.result); if(document.getElementById('note-window').style.display==='flex') notes.autoSave(); else loader.save(); };
                        r.readAsDataURL(blob); e.preventDefault();
                    }
                }
            };
            document.getElementById('window-editor').onpaste = h;
            document.querySelectorAll('.rich-box').forEach(b => b.onpaste = h);
        }

        const tools = {
            exec: (cmd, val) => { document.designMode="on"; document.execCommand(cmd,false,val); document.designMode="off"; loader.save(); if(cmd!=='BackColor' && cmd!=='ForeColor') ribbon.hide(); },
            bg: (c) => tools.exec("BackColor", c), fg: (c) => tools.exec("ForeColor", c), clear: () => tools.exec("removeFormat", null),
            addNote: () => {
                let sel = window.getSelection(); if(sel.isCollapsed) return;
                sel.collapseToEnd();
                let id = Date.now();
                let s = document.createElement("sup"); s.className = "note-marker"; s.dataset.id = id; s.contentEditable = "false";
                s.onclick = (e) => { e.stopPropagation(); notes.open(id); };
                sel.getRangeAt(0).insertNode(s);
                ribbon.hide(); notes.open(id); loader.save();
            }
        };

        const notes = {
            open: (id) => {
                state.activeNoteId = id;
                document.getElementById('note-window').style.display = 'flex';
                fbDb.ref(`users/${state.user.uid}/notes_data/${id}`).once('value', s => document.getElementById('window-editor').innerHTML = s.val() || "");
            },
            close: () => document.getElementById('note-window').style.display = 'none',
            autoSave: () => { fbDb.ref(`users/${state.user.uid}/notes_data/${state.activeNoteId}`).set(document.getElementById('window-editor').innerHTML); },
            save: () => { notes.autoSave(); notes.close(); },
            delete: () => {
                fbDb.ref(`users/${state.user.uid}/notes_data/${state.activeNoteId}`).remove();
                let el = document.querySelector(`.note-marker[data-id="${state.activeNoteId}"]`);
                if(el) el.remove();
                notes.close(); loader.save();
            }
        };

        const ribbon = {
            show: () => {
                setTimeout(() => {
                    let sel = window.getSelection();
                    if(!sel.isCollapsed) {
                        let r = sel.getRangeAt(0).getBoundingClientRect();
                        let m = document.getElementById('ribbon');
                        m.style.display = 'flex'; m.style.top = (r.top + window.scrollY - 130) + 'px'; m.style.left = r.left + 'px';
                    }
                }, 50);
            },
            hide: () => document.getElementById('ribbon').style.display = 'none'
        };

        // SUPER DETECTOR V57 (REGEX MEJORADO)
        const bible = {
            fetch: (ref) => {
                document.getElementById('bible-window').style.display = 'flex';
                document.getElementById('bible-title').innerText = ref;
                document.getElementById('bible-content').innerHTML = '<p style="text-align:center">Cargando...</p>';
                
                // 1. Limpiar y Estandarizar
                let clean = ref.replace(/`/g, '').trim();
                // Mapeo b√°sico
                if(clean.startsWith("G√©n")) clean = clean.replace("G√©n", "Genesis");
                else if(clean.startsWith("√âx")) clean = clean.replace("√âx", "Exodus");
                else if(clean.startsWith("Sal")) clean = clean.replace("Sal", "Psalms");
                
                // Quitar espacios raros para la API
                let apiRef = clean.replace(/\s*:\s*/g, ':');

                fetch(`https://bible-api.com/${encodeURIComponent(apiRef)}?translation=almeida`).then(r=>r.json())
                .then(d => {
                    if(d.text) document.getElementById('bible-content').innerText = d.text;
                    else document.getElementById('bible-content').innerText = "No encontrado.";
                }).catch(()=>document.getElementById('bible-content').innerText="Error.");
                
                document.getElementById('bible-ext-link').href = `https://www.biblegateway.com/passage/?search=${encodeURIComponent(ref)}&version=RVR1960`;
            }
        };

        const ui = {
            cycleMode: () => {
                const b = document.body;
                if(!b.className) b.className = 'sepia';
                else if(b.className === 'sepia') b.className = 'amber';
                else if(b.className === 'amber') b.className = 'dark';
                else b.className = '';
            },
            font: (v) => {
                let el = document.getElementById('content');
                el.style.fontSize = (parseInt(window.getComputedStyle(el).fontSize) + v) + 'px';
            }
        };

        function parser(md) {
            md = md.replace(/^---[\s\S]*?---/, "");
            md = md.replace(/^# (.*)/gm, '<h1>$1</h1>');
            md = md.replace(/^## (.*)/gm, '<h2>$1</h2>');
            md = md.replace(/^### (.*)/gm, '<h3>$1</h3>');
            md = md.replace(/\*\*(.*)\*\*/gm, '<b>$1</b>');
            md = md.replace(/> (.*)/gm, '<blockquote>$1</blockquote>');
            
            // SUPER REGEX V57: Tolera espacios en citas (2: 15)
            md = md.replace(/(`?([1-3]\s?)?[A-Z√ë√Å√â√ç√ì√ö][a-z√±√°√©√≠√≥√∫]+\.?\s+\d+\s*:\s*\d+(?:[-‚Äì,]\s?\d+)*`?)/g, '<span class="bible-link">$1</span>');
            
            let h = "";
            md.split('\n').forEach((l, i) => {
                if(l.trim()) {
                    h += `<p>${l}</p>`;
                    if(l.includes('?') || l.includes('Lee')) {
                        let id = `ans-${i}`;
                        h += `<span class="question-label">Tu respuesta:</span>
                              <div class="rich-box" contenteditable="true" placeholder="Escribe aqu√≠..." oninput="loader.saveInput('${id}', this.innerHTML)" id="${id}"></div>`;
                    }
                }
            });
            return h;
        }
        
        document.addEventListener('keydown', e => {
            if(document.activeElement.isContentEditable || document.activeElement.tagName==='INPUT') return;
            if(e.key === "ArrowLeft") nav.prev();
            if(e.key === "ArrowRight") nav.next();
        });
    </script>
</body>
</html>
