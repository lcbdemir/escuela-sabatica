<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Escuela Sabática V30 - Suite de Estudio</title>
    <!-- Iconos Material Design -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --bg: #ffffff;
            --text: #222;
            --primary: #004d40;
            --accent: #d81b60;
            --paper: #f4f6f8;
            --ribbon-bg: #222;
            --ribbon-text: #fff;
        }
        body.dark-mode {
            --bg: #121212;
            --text: #e0e0e0;
            --primary: #80cbc4;
            --accent: #f48fb1;
            --paper: #1e1e1e;
            --ribbon-bg: #fff;
            --ribbon-text: #000;
        }
        body { 
            font-family: 'Georgia', serif; margin: 0; background: var(--bg); color: var(--text); 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
        }

        /* HEADER DE NAVEGACIÓN */
        header {
            background: var(--paper); padding: 10px; border-bottom: 2px solid var(--primary);
            display: flex; gap: 10px; align-items: center; z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        select {
            flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc; 
            font-size: 0.9rem; background: var(--bg); color: var(--text);
        }
        .btn-icon { 
            background: none; border: none; cursor: pointer; color: var(--text); 
            padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        .btn-icon:hover { background: rgba(0,0,0,0.1); }

        /* ÁREA DE CONTENIDO */
        #main-container { 
            flex: 1; overflow-y: auto; padding: 20px 20px 100px 20px; 
            max-width: 800px; margin: 0 auto; width: 100%; box-sizing: border-box; 
            position: relative;
        }
        
        /* TIPOGRAFÍA */
        #content h1 { color: var(--primary); font-size: 1.6rem; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        #content h2 { color: var(--text); font-size: 1.3rem; margin-top: 30px; font-weight: bold; }
        #content h3 { color: var(--accent); font-size: 1.1rem; margin-top: 25px; }
        #content p { line-height: 1.8; font-size: 1.15rem; margin-bottom: 15px; }
        blockquote { border-left: 4px solid var(--primary); padding-left: 15px; color: #666; font-style: italic; margin: 20px 0; background: rgba(0,0,0,0.03); padding: 10px; }
        .bible-ref { color: var(--primary); font-weight: bold; text-decoration: underline; cursor: pointer; text-decoration-style: dotted; }

        /* CINTA FLOTANTE (POP-UP) */
        #floating-ribbon {
            position: absolute; display: none; background: var(--ribbon-bg); color: var(--ribbon-text);
            border-radius: 8px; padding: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000; align-items: center; gap: 8px; flex-wrap: nowrap; white-space: nowrap;
        }
        #floating-ribbon::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; border-color: var(--ribbon-bg) transparent transparent transparent;
        }
        .ribbon-btn {
            background: none; border: none; color: var(--ribbon-text); cursor: pointer;
            padding: 5px; display: flex; align-items: center; border-radius: 4px;
        }
        .ribbon-btn:hover { background: rgba(128,128,128,0.3); }
        .ribbon-sep { width: 1px; height: 20px; background: #666; margin: 0 2px; }
        
        /* Selector de Color en Cinta */
        input[type="color"] {
            -webkit-appearance: none; border: none; width: 24px; height: 24px; padding: 0; 
            border-radius: 50%; overflow: hidden; cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; }

        /* NOTAS LATERALES / OVERLAY */
        #note-overlay {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 50%; 
            background: var(--bg); box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            z-index: 2000; display: none; flex-direction: column; padding: 20px; box-sizing: border-box;
            border-top-left-radius: 15px; border-top-right-radius: 15px; transition: transform 0.3s;
        }
        #note-text { flex: 1; border: 1px solid #ccc; padding: 10px; border-radius: 8px; font-family: sans-serif; resize: none; margin-top: 10px; background: var(--paper); color: var(--text); }
        .note-header { display: flex; justify-content: space-between; align-items: center; }

        /* BIBLIA MODAL */
        #bible-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff; width: 90%; max-width: 600px; height: 80%; border-radius: 8px;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .modal-header { padding: 10px; background: #eee; display: flex; justify-content: space-between; color:#333; font-weight:bold;}
        iframe { flex: 1; border: none; }

        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: var(--paper); padding: 30px; border-radius: 12px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 5px;}
        
        .hidden { display: none !important; }
    </style>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-card">
            <h2 style="color:var(--primary)">Mi Estudio</h2>
            <input id="email" type="email" placeholder="Correo">
            <input id="pass" type="password" placeholder="Contraseña">
            <button class="btn-main" onclick="auth.login()">Ingresar</button>
            <button class="btn-main" style="background:#555" onclick="auth.reg()">Registrarme</button>
            <p id="msg" style="color:red; margin-top:10px; font-size:0.8rem"></p>
        </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
        <header>
            <select id="sel-quarter" onchange="nav.loadLessons()">
                <option value="2025-04">Josué (2025-04)</option>
                <option value="2025-03">Éxodo</option>
                <option value="2025-02">Santuario</option>
                <option value="2025-01">Gran Conflicto</option>
            </select>
            <select id="sel-lesson" onchange="nav.updateDays()">
                <option>Lección...</option>
            </select>
            <select id="sel-day" onchange="reader.load()">
                <option>Día...</option>
            </select>
            <button class="btn-icon" onclick="ui.theme()"><i class="material-icons">brightness_4</i></button>
            <button class="btn-icon" onclick="auth.logout()" style="color:red"><i class="material-icons">logout</i></button>
        </header>

        <div id="main-container" onmouseup="ribbon.check(event)" ontouchend="ribbon.check(event)">
            <div id="content">
                <p style="text-align:center; padding-top:50px; color:#888">Selecciona una lección arriba.</p>
            </div>
        </div>

        <!-- CINTA FLOTANTE -->
        <div id="floating-ribbon">
            <input type="color" id="color-picker" onchange="highlighter.applyColor(this.value)" value="#ffff00" title="Elegir Color">
            <div class="ribbon-sep"></div>
            <button class="ribbon-btn" onclick="highlighter.style('solid')" title="Resaltar Fondo"><i class="material-icons" style="font-size:18px">border_color</i></button>
            <button class="ribbon-btn" onclick="highlighter.style('underline')" title="Subrayar"><i class="material-icons" style="font-size:18px">format_underlined</i></button>
            <button class="ribbon-btn" onclick="highlighter.style('wavy')" title="Ondulado"><i class="material-icons" style="font-size:18px">waves</i></button>
            <div class="ribbon-sep"></div>
            <button class="ribbon-btn" onclick="notes.open()" title="Añadir Nota"><i class="material-icons" style="font-size:18px">note_add</i></button>
            <!-- <button class="ribbon-btn" onclick="highlighter.clear()" title="Borrar"><i class="material-icons" style="font-size:18px">format_clear</i></button> -->
        </div>

        <!-- EDITOR DE NOTAS -->
        <div id="note-overlay">
            <div class="note-header">
                <strong>Nota Personal</strong>
                <button onclick="notes.saveAndClose()" style="background:var(--primary); color:white; border:none; padding:5px 10px; border-radius:4px;">Guardar</button>
            </div>
            <textarea id="note-text" placeholder="Escribe aquí tu pensamiento, pega imágenes o diagramas..."></textarea>
            <div style="font-size:0.7rem; color:#666; margin-top:5px;">Esta nota se guardará sincronizada con tu cuenta.</div>
        </div>
    </div>

    <!-- BIBLIA -->
    <div id="bible-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Santa Biblia</span>
                <button onclick="document.getElementById('bible-modal').style.display='none'" style="border:none; background:none; font-size:1.2rem">✕</button>
            </div>
            <iframe id="bible-frame" src=""></iframe>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyD8Z79dXBAIYXYYm-hvyJZszGiTiX1cdLk",
          authDomain: "miescuelasabatica-fdb06.firebaseapp.com",
          databaseURL: "https://miescuelasabatica-fdb06-default-rtdb.firebaseio.com",
          projectId: "miescuelasabatica-fdb06",
          storageBucket: "miescuelasabatica-fdb06.firebasestorage.app",
          messagingSenderId: "832420279762",
          appId: "1:832420279762:web:4218b0fa30e2e93b12c40b"
        };
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const fbDb = firebase.database();

        const state = { user: null, q: '2025-04', l: '01', d: '01', selection: null };

        // AUTH
        const auth = {
            login: () => fbAuth.signInWithEmailAndPassword(val('email'), val('pass')).catch(e=>msg(e.message)),
            reg: () => fbAuth.createUserWithEmailAndPassword(val('email'), val('pass')).catch(e=>msg(e.message)),
            logout: () => location.reload()
        };
        function val(id){ return document.getElementById(id).value; }
        function msg(t){ document.getElementById('msg').innerText = t; }

        fbAuth.onAuthStateChanged(u => {
            if(u){
                state.user = u;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                nav.init();
            }
        });

        // NAVEGACIÓN
        const nav = {
            init: () => nav.loadLessons(),
            loadLessons: () => {
                const sel = document.getElementById('sel-lesson');
                sel.innerHTML = "";
                for(let i=1; i<=14; i++){
                    let n = i<10 ? "0"+i : ""+i;
                    let opt = document.createElement('option');
                    opt.value = n; opt.innerText = "Lección " + n;
                    sel.appendChild(opt);
                }
                nav.updateDays();
            },
            updateDays: () => {
                const days = ["Sábado", "Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];
                const codes = ["01", "02", "03", "04", "05", "06", "07"];
                const sel = document.getElementById('sel-day');
                sel.innerHTML = "";
                days.forEach((d, i) => {
                    let opt = document.createElement('option');
                    opt.value = codes[i]; opt.innerText = d;
                    sel.appendChild(opt);
                });
                reader.load();
            }
        };

        // LECTOR
        const reader = {
            load: async () => {
                state.q = document.getElementById('sel-quarter').value;
                state.l = document.getElementById('sel-lesson').value;
                state.d = document.getElementById('sel-day').value;
                
                const container = document.getElementById('content');
                container.innerHTML = '<p style="text-align:center; padding:50px">Cargando...</p>';

                const url = `https://raw.githubusercontent.com/Adventech/sabbath-school-lessons/master/src/es/${state.q}/${state.l}/${state.d}.md`;
                
                try {
                    const r = await fetch(url);
                    if(!r.ok) throw new Error("No encontrado");
                    let md = await r.text();
                    container.innerHTML = markdownParser(md);
                    notes.loadAll(); // Cargar notas globales del día
                } catch(e) {
                    container.innerHTML = `<p style="color:red; text-align:center">Error cargando lección.</p>`;
                }
            }
        };

        function markdownParser(md) {
            md = md.replace(/^---[\s\S]*?---/, "");
            md = md.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            md = md.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            md = md.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            md = md.replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>');
            md = md.replace(/\*(.*)\*/gim, '<em>$1</em>');
            md = md.replace(/> (.*$)/gim, '<blockquote>$1</blockquote>');
            
            // Referencias Bíblicas
            const bibleRegex = /([1-3]?\s?[A-ZÑ][a-zñáéíóú]+\.?\s\d+:\d+(?:-\d+)?)/g;
            md = md.replace(bibleRegex, '<span class="bible-ref" onclick="bible.open(\'$1\')">$1</span>');
            
            // Párrafos
            return md.split('\n').map(line => line.trim() ? `<p>${line}</p>` : '').join('');
        }

        // CINTA FLOTANTE
        const ribbon = {
            check: (e) => {
                // Pequeño delay para asegurar que la selección terminó
                setTimeout(() => {
                    const sel = window.getSelection();
                    const menu = document.getElementById('floating-ribbon');
                    
                    if (sel.toString().length > 0 && !sel.isCollapsed) {
                        const range = sel.getRangeAt(0);
                        const rect = range.getBoundingClientRect();
                        
                        // Posicionar encima
                        menu.style.display = 'flex';
                        menu.style.top = (rect.top + window.scrollY - 50) + 'px';
                        
                        // Centrar horizontalmente pero mantener en pantalla
                        let left = rect.left + (rect.width / 2) - (menu.offsetWidth / 2);
                        if(left < 10) left = 10;
                        if(left + menu.offsetWidth > window.innerWidth) left = window.innerWidth - menu.offsetWidth - 10;
                        
                        menu.style.left = left + 'px';
                        state.selection = range; // Guardar rango
                    } else {
                        // Si hace clic en el menú, no cerrar
                        if (!menu.contains(e.target)) {
                            menu.style.display = 'none';
                        }
                    }
                }, 100);
            }
        };

        // RESALTADOR Y ESTILOS
        const highlighter = {
            applyColor: (color) => {
                document.designMode = "on";
                document.execCommand("BackColor", false, color);
                document.designMode = "off";
                document.getElementById('floating-ribbon').style.display = 'none';
            },
            style: (type) => {
                const sel = window.getSelection();
                if (!sel.rangeCount) return;
                
                const span = document.createElement("span");
                span.textContent = sel.toString();
                
                if (type === 'underline') span.style.textDecoration = "underline";
                if (type === 'wavy') { span.style.textDecoration = "underline"; span.style.textDecorationStyle = "wavy"; span.style.textDecorationColor = "red"; }
                if (type === 'solid') span.style.borderBottom = "3px solid var(--primary)";
                
                const range = sel.getRangeAt(0);
                range.deleteContents();
                range.insertNode(span);
                
                document.getElementById('floating-ribbon').style.display = 'none';
            },
            clear: () => {
                document.designMode = "on";
                document.execCommand("removeFormat", false, null);
                document.designMode = "off";
            }
        };

        // NOTAS
        const notes = {
            open: () => {
                document.getElementById('note-overlay').style.display = 'flex';
                document.getElementById('floating-ribbon').style.display = 'none';
                document.getElementById('note-text').focus();
            },
            saveAndClose: () => {
                const text = document.getElementById('note-text').value;
                if(text) {
                    const id = `note-${state.q}-${state.l}-${state.d}`;
                    // Guardar como array de notas o concatenar
                    fbDb.ref(`users/${state.user.uid}/notes/${id}`).push({
                        text: text,
                        date: new Date().toISOString()
                    });
                    alert("Nota guardada");
                    document.getElementById('note-text').value = "";
                }
                document.getElementById('note-overlay').style.display = 'none';
            },
            loadAll: () => {
                // Aquí podrías cargar las notas y mostrarlas al final o como iconos
            }
        };

        // BIBLIA
        const bible = {
            open: (ref) => {
                document.getElementById('bible-modal').style.display = 'flex';
                const url = `https://www.biblegateway.com/passage/?search=${encodeURIComponent(ref)}&version=RVR1960&interface=print`;
                document.getElementById('bible-frame').src = url;
            }
        };

        const ui = {
            theme: () => document.body.classList.toggle('dark-mode')
        };
    </script>
</body>
</html>
