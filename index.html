<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Escuela Sab√°tica V32 - Persistencia Total</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --bg: #ffffff;
            --text: #222;
            --primary: #004d40;
            --secondary: #e0f2f1;
            --accent: #c62828;
            --ribbon-bg: #263238;
        }
        body.dark-mode {
            --bg: #121212;
            --text: #e0e0e0;
            --primary: #80cbc4;
            --secondary: #1e1e1e;
            --accent: #ef9a9a;
            --ribbon-bg: #eceff1;
        }
        /* Modo Sepia */
        body.sepia-mode {
            --bg: #f4ecd8;
            --text: #5b4636;
            --primary: #5d4037;
            --secondary: #eefebe;
        }

        body { font-family: 'Georgia', serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { background: var(--secondary); padding: 8px; border-bottom: 2px solid var(--primary); display: flex; gap: 5px; align-items: center; z-index: 100; flex-wrap: wrap;}
        select { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: var(--bg); color: var(--text); min-width: 80px;}
        .tool-btn { background: none; border: 1px solid transparent; cursor: pointer; padding: 5px; border-radius: 4px; color: var(--text); }
        .tool-btn:hover { background: rgba(0,0,0,0.1); }

        /* CONTENIDO EDITABLE */
        #main-container { 
            flex: 1; overflow-y: auto; padding: 20px; max-width: 800px; margin: 0 auto; width: 100%; box-sizing: border-box; 
            outline: none; /* Quitar borde al editar */
        }
        
        /* ESTILOS DEL TEXTO */
        h1 { color: var(--primary); border-bottom: 1px solid #ccc; font-size: 1.6em; }
        h2 { color: var(--text); margin-top: 30px; font-weight: bold; font-size: 1.3em; }
        h3 { color: var(--accent); margin-top: 20px; font-size: 1.1em; }
        p { line-height: 1.8; font-size: 1.15em; margin-bottom: 15px; }
        blockquote { border-left: 4px solid var(--primary); padding-left: 15px; font-style: italic; color: #555; background: rgba(0,0,0,0.02); padding: 10px; margin: 20px 0; }
        .bible-link { color: var(--primary); font-weight: bold; text-decoration: underline; cursor: pointer; }
        
        /* ICONO DE NOTA */
        .note-icon { cursor: pointer; font-size: 1.2em; vertical-align: middle; margin: 0 2px; text-decoration: none !important; }

        /* CINTA FLOTANTE */
        #ribbon {
            position: absolute; display: none; background: var(--ribbon-bg); padding: 5px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1000; align-items: center; gap: 8px; flex-wrap: wrap;
        }
        /* Flecha abajo */
        #ribbon::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: var(--ribbon-bg) transparent transparent transparent;
        }
        .rib-group { display: flex; align-items: center; gap: 5px; border-right: 1px solid #666; padding-right: 8px; margin-right: 2px;}
        .rib-group:last-child { border: none; }
        .rib-btn { background: none; border: none; color: #fff; cursor: pointer; padding: 4px; border-radius: 3px; display: flex; }
        .rib-btn:hover { background: rgba(255,255,255,0.2); }
        body.dark-mode .rib-btn { color: #000; }
        
        /* Inputs de Color */
        .color-wrapper { position: relative; width: 24px; height: 24px; border-radius: 50%; overflow: hidden; border: 2px solid #fff; }
        input[type="color"] { border: none; width: 150%; height: 150%; margin: -25%; cursor: pointer; padding: 0; }

        /* MODALES */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-box { background: var(--bg); padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 80%; display: flex; flex-direction: column; }
        textarea#note-input { width: 100%; height: 150px; margin: 10px 0; padding: 10px; box-sizing: border-box; resize: none; font-size: 16px;}
        
        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: var(--secondary); padding: 30px; border-radius: 12px; width: 300px; text-align: center; }
        .inp { width: 100%; padding: 10px; margin: 10px 0; }
        .btn-log { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }

        .hidden { display: none !important; }
    </style>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-card">
            <h2 style="color:var(--primary)">Mi Estudio</h2>
            <input id="email" class="inp" type="email" placeholder="Email">
            <input id="pass" class="inp" type="password" placeholder="Contrase√±a">
            <button class="btn-log" onclick="auth.login()">Ingresar</button>
            <p id="msg" style="color:red; font-size:0.8rem"></p>
        </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
        <header>
            <select id="sel-q" onchange="nav.changeQuarter()"></select>
            <select id="sel-l" onchange="nav.changeLesson()"></select>
            <select id="sel-d" onchange="loader.loadDay()"></select>
            
            <button class="tool-btn" onclick="ui.cycleTheme()" title="Cambiar Tema"><i class="material-icons">brightness_medium</i></button>
            <button class="tool-btn" onclick="ui.font(2)">A+</button>
            <button class="tool-btn" onclick="ui.font(-2)">A-</button>
            <button class="tool-btn" onclick="auth.logout()" style="color:red"><i class="material-icons">logout</i></button>
        </header>

        <!-- CONTENIDO EDITABLE -->
        <!-- contenteditable="true" permite que execCommand funcione nativamente -->
        <div id="main-container" onmouseup="ribbon.show()" ontouchend="ribbon.show()">
            <div id="content">
                <p style="text-align:center; margin-top:50px">Cargando...</p>
            </div>
        </div>

        <!-- CINTA FLOTANTE -->
        <div id="ribbon">
            <!-- Colores de Fondo (Resaltado) -->
            <div class="rib-group">
                <i class="material-icons" style="font-size:14px; color:#fff; margin-right:3px">format_paint</i>
                <div class="color-wrapper" title="Resaltar Amarillo" style="background:yellow"><div onclick="tools.highlight('#ffff00')" style="width:100%;height:100%"></div></div>
                <div class="color-wrapper" title="Resaltar Verde" style="background:#a5d6a7"><div onclick="tools.highlight('#a5d6a7')" style="width:100%;height:100%"></div></div>
                <div class="color-wrapper" title="Resaltar Azul" style="background:#90caf9"><div onclick="tools.highlight('#90caf9')" style="width:100%;height:100%"></div></div>
                <!-- Personalizable -->
                <div class="color-wrapper" title="Color Personalizado">
                    <input type="color" onchange="tools.highlight(this.value)">
                </div>
            </div>

            <!-- Color de Texto -->
            <div class="rib-group">
                <i class="material-icons" style="font-size:14px; color:#fff; margin-right:3px">text_format</i>
                <div class="color-wrapper" title="Texto Rojo" style="background:red"><div onclick="tools.textColor('red')" style="width:100%;height:100%"></div></div>
                <div class="color-wrapper" title="Elegir Color Texto">
                    <input type="color" onchange="tools.textColor(this.value)">
                </div>
            </div>

            <!-- Estilos y Notas -->
            <div class="rib-group">
                <button class="rib-btn" onclick="tools.format('underline')" title="Subrayar"><i class="material-icons">format_underlined</i></button>
                <button class="rib-btn" onclick="tools.format('strikeThrough')" title="Tachar"><i class="material-icons">strikethrough_s</i></button>
                <button class="rib-btn" onclick="tools.addNote()" title="Agregar Nota"><i class="material-icons">note_add</i></button>
                <button class="rib-btn" onclick="tools.clear()" title="Limpiar Formato"><i class="material-icons">format_clear</i></button>
            </div>
        </div>

        <!-- MODAL NOTA -->
        <div id="note-modal" class="modal">
            <div class="modal-box">
                <h3>Editar Nota</h3>
                <textarea id="note-input" placeholder="Escribe aqu√≠..."></textarea>
                <div style="display:flex; justify-content:space-between">
                    <button class="btn-log" style="background:#d32f2f; width:auto" onclick="notes.delete()">Eliminar</button>
                    <button class="btn-log" style="background:var(--primary); width:auto" onclick="notes.save()">Guardar</button>
                </div>
            </div>
        </div>

        <!-- MODAL BIBLIA -->
        <div id="bible-modal" class="modal">
            <div class="modal-box" style="height:80%; max-width:600px">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px">
                    <h3 style="margin:0">Biblia RVR1960</h3>
                    <button onclick="document.getElementById('bible-modal').style.display='none'">‚úï</button>
                </div>
                <iframe id="bible-frame" style="flex:1; border:none" src=""></iframe>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyD8Z79dXBAIYXYYm-hvyJZszGiTiX1cdLk",
          authDomain: "miescuelasabatica-fdb06.firebaseapp.com",
          databaseURL: "https://miescuelasabatica-fdb06-default-rtdb.firebaseio.com",
          projectId: "miescuelasabatica-fdb06",
          storageBucket: "miescuelasabatica-fdb06.firebasestorage.app",
          messagingSenderId: "832420279762",
          appId: "1:832420279762:web:4218b0fa30e2e93b12c40b"
        };
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const fbDb = firebase.database();

        const state = { user: null, q: '2025-04', l: '01', d: '01', currentNoteId: null };

        // --- AUTH ---
        const auth = {
            login: () => fbAuth.signInWithEmailAndPassword(val('email'), val('pass')).catch(e=>msg(e.message)),
            reg: () => fbAuth.createUserWithEmailAndPassword(val('email'), val('pass')).catch(e=>msg(e.message))
        };
        function val(id){ return document.getElementById(id).value; }
        function msg(t){ document.getElementById('msg').innerText = t; }

        fbAuth.onAuthStateChanged(u => {
            if(u){
                state.user = u;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                nav.init();
            }
        });

        // --- NAVEGACI√ìN AUTOM√ÅTICA ---
        const nav = {
            init: () => {
                // Generar Trimestres (Manuales 2025)
                const qSel = document.getElementById('sel-q');
                qSel.add(new Option("Josu√© (Actual)", "2025-04"));
                qSel.add(new Option("√âxodo", "2025-03"));
                qSel.add(new Option("Santuario", "2025-02"));
                
                // Generar Lecciones 1-14
                const lSel = document.getElementById('sel-l');
                for(let i=1; i<=14; i++) {
                    let n = i<10 ? "0"+i : ""+i;
                    lSel.add(new Option("Lec "+n, n));
                }

                // Generar D√≠as
                const dSel = document.getElementById('sel-d');
                const days = ["S√°bado","Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes"];
                const codes = ["01","02","03","04","05","06","07"];
                days.forEach((d,i) => dSel.add(new Option(d, codes[i])));

                // CALCULAR FECHA DE HOY PARA IR AL GRANO
                nav.autoSelectDate();
            },
            
            autoSelectDate: () => {
                // C√°lculo aproximado para ir a la lecci√≥n de hoy
                // Inicio Trimestre 4 2025: S√°bado 27 Sep (aprox)
                // Usamos fecha fija de inicio para calcular offset
                const startQ4 = new Date('2025-09-27').getTime();
                const now = new Date().getTime();
                const diffDays = Math.floor((now - startQ4) / (1000 * 60 * 60 * 24));
                
                if (diffDays >= 0 && diffDays < 98) { // Estamos en el trimestre
                    let l = Math.floor(diffDays / 7) + 1;
                    let d = (diffDays % 7) + 1; // 1=Sab
                    
                    let lStr = l < 10 ? "0"+l : ""+l;
                    let dStr = "0" + d; // Simple mapping for now
                    
                    document.getElementById('sel-l').value = lStr;
                    document.getElementById('sel-d').value = dStr;
                }
                
                loader.loadDay();
            },

            changeQuarter: () => { state.q = document.getElementById('sel-q').value; loader.loadDay(); },
            changeLesson: () => { state.l = document.getElementById('sel-l').value; loader.loadDay(); }
        };

        // --- CARGADOR Y GUARDADO (EL CEREBRO) ---
        const loader = {
            loadDay: async () => {
                ribbon.hide();
                state.q = document.getElementById('sel-q').value;
                state.l = document.getElementById('sel-l').value;
                state.d = document.getElementById('sel-d').value;
                
                const container = document.getElementById('content');
                container.innerHTML = '<p style="text-align:center; padding:50px">Cargando...</p>';

                // 1. INTENTAR CARGAR VERSI√ìN GUARDADA EN FIREBASE (PERSISTENCIA)
                const refPath = `users/${state.user.uid}/saved_days/${state.q}-${state.l}-${state.d}`;
                
                fbDb.ref(refPath).once('value', async (s) => {
                    const savedHTML = s.val();
                    
                    if (savedHTML) {
                        // Si existe guardado, mostrar eso
                        container.innerHTML = savedHTML;
                        loader.attachEvents(); // Reconectar eventos a las notas
                    } else {
                        // Si no, descargar de GitHub
                        await loader.fetchFromGitHub();
                    }
                });
            },

            fetchFromGitHub: async () => {
                const url = `https://raw.githubusercontent.com/Adventech/sabbath-school-lessons/master/src/es/${state.q}/${state.l}/${state.d}.md`;
                try {
                    const r = await fetch(url);
                    if(!r.ok) throw new Error();
                    const md = await r.text();
                    document.getElementById('content').innerHTML = parser(md);
                    loader.attachEvents();
                } catch(e) {
                    document.getElementById('content').innerHTML = "<p>Contenido no disponible.</p>";
                }
            },

            saveWork: () => {
                // GUARDAR TODO EL HTML ACTUAL (Con colores y notas)
                const html = document.getElementById('content').innerHTML;
                const refPath = `users/${state.user.uid}/saved_days/${state.q}-${state.l}-${state.d}`;
                fbDb.ref(refPath).set(html);
            },

            attachEvents: () => {
                // Reconectar clics a notas y biblias despu√©s de inyectar HTML
                document.querySelectorAll('.note-icon').forEach(el => {
                    el.onclick = (e) => { e.stopPropagation(); notes.open(el.dataset.id); };
                });
                document.querySelectorAll('.bible-link').forEach(el => {
                    el.onclick = (e) => { e.stopPropagation(); bible.open(el.innerText); };
                });
            }
        };

        // --- HERRAMIENTAS DE TEXTO ---
        const tools = {
            highlight: (color) => {
                document.designMode = "on";
                document.execCommand("BackColor", false, color);
                document.designMode = "off";
                ribbon.hide();
                loader.saveWork(); // Guardar cambio
            },
            textColor: (color) => {
                document.designMode = "on";
                document.execCommand("ForeColor", false, color);
                document.designMode = "off";
                ribbon.hide();
                loader.saveWork();
            },
            format: (cmd) => {
                document.designMode = "on";
                document.execCommand(cmd, false, null);
                document.designMode = "off";
                ribbon.hide();
                loader.saveWork();
            },
            clear: () => {
                document.designMode = "on";
                document.execCommand("removeFormat", false, null);
                document.designMode = "off";
                ribbon.hide();
                loader.saveWork();
            },
            addNote: () => {
                const sel = window.getSelection();
                if(!sel.rangeCount) return;
                
                // Expandir a palabra completa para no romper
                const range = sel.getRangeAt(0);
                if (sel.isCollapsed) {
                    // L√≥gica simple de expansi√≥n (opcional, por ahora inserta ah√≠)
                }

                const id = Date.now().toString();
                const icon = document.createElement('span');
                icon.className = "note-icon";
                icon.innerHTML = "üìù";
                icon.dataset.id = id;
                icon.contentEditable = "false"; // Importante para no borrarlo al escribir
                icon.onclick = (e) => { e.stopPropagation(); notes.open(id); };

                // Insertar
                range.collapse(false);
                range.insertNode(icon);
                
                ribbon.hide();
                notes.open(id); // Abrir para editar inmediatamente
                loader.saveWork();
            }
        };

        // --- GESTOR DE NOTAS ---
        const notes = {
            open: (id) => {
                state.currentNoteId = id;
                document.getElementById('note-modal').style.display = 'flex';
                // Buscar contenido en Firebase (guardamos el texto de la nota separado para facilitar edici√≥n)
                fbDb.ref(`users/${state.user.uid}/notes_data/${id}`).once('value', s => {
                    document.getElementById('note-input').value = s.val() || "";
                });
            },
            save: () => {
                const txt = document.getElementById('note-input').value;
                const id = state.currentNoteId;
                
                // Si est√° vac√≠o, borrar nota
                if (!txt.trim()) {
                    notes.delete();
                    return;
                }

                // Guardar contenido
                fbDb.ref(`users/${state.user.uid}/notes_data/${id}`).set(txt);
                document.getElementById('note-modal').style.display = 'none';
                loader.saveWork(); // Guardar el icono en el HTML
            },
            delete: () => {
                const id = state.currentNoteId;
                // Borrar datos
                fbDb.ref(`users/${state.user.uid}/notes_data/${id}`).remove();
                
                // Borrar icono del DOM
                const icon = document.querySelector(`.note-icon[data-id="${id}"]`);
                if(icon) icon.remove();
                
                document.getElementById('note-modal').style.display = 'none';
                loader.saveWork();
            }
        };

        // --- CINTA Y UI ---
        const ribbon = {
            show: () => {
                setTimeout(() => {
                    const sel = window.getSelection();
                    if(sel.toString().length > 0 && !sel.isCollapsed) {
                        const range = sel.getRangeAt(0);
                        const rect = range.getBoundingClientRect();
                        const menu = document.getElementById('ribbon');
                        
                        menu.style.display = 'flex';
                        menu.style.top = (rect.top + window.scrollY - 50) + 'px';
                        let left = rect.left + (rect.width/2) - (menu.offsetWidth/2);
                        // Ajuste bordes pantalla
                        if(left < 10) left = 10; 
                        menu.style.left = left + 'px';
                    }
                }, 100);
            },
            hide: () => document.getElementById('ribbon').style.display = 'none'
        };

        const ui = {
            cycleTheme: () => {
                const b = document.body;
                if(!b.className) b.className = 'sepia-mode';
                else if(b.className === 'sepia-mode') b.className = 'dark-mode';
                else b.className = '';
            },
            font: (v) => {
                const el = document.getElementById('content');
                const s = parseInt(window.getComputedStyle(el).fontSize);
                el.style.fontSize = (s+v) + 'px';
            }
        };

        const bible = {
            open: (ref) => {
                document.getElementById('bible-modal').style.display = 'flex';
                const url = `https://www.biblegateway.com/passage/?search=${encodeURIComponent(ref)}&version=RVR1960&interface=print`;
                document.getElementById('bible-frame').src = url;
            }
        };

        // Parser Simple
        function parser(md) {
            md = md.replace(/^---[\s\S]*?---/, "");
            md = md.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            md = md.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            md = md.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            md = md.replace(/\*\*(.*)\*\*/gim, '<b>$1</b>');
            md = md.replace(/> (.*$)/gim, '<blockquote>$1</blockquote>');
            // Citas B√≠blicas
            md = md.replace(/([1-3]?\s?[A-Z√ë][a-z√±√°√©√≠√≥√∫]+\.?\s\d+:\d+(?:-\d+)?)/g, '<span class="bible-link">$1</span>');
            return md.split('\n').map(l => l.trim() ? `<p>${l}</p>` : '').join('');
        }
    </script>
</body>
</html>
