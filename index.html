<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escuela Sab√°tica V27 - Lectura Cruda</title>
    
    <style>
        :root {
            --bg: #ffffff;
            --text: #222;
            --primary: #b71c1c; /* Rojo intenso */
            --light: #f5f5f5;
            --font: 'Georgia', serif;
        }
        body.dark-mode {
            --bg: #121212;
            --text: #ddd;
            --primary: #ef5350;
            --light: #1e1e1e;
        }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        header { padding: 15px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; background: var(--light); }
        h1 { margin: 0; font-size: 1rem; color: var(--primary); font-weight: 800; }
        button { cursor: pointer; border: 1px solid #ccc; background: var(--bg); padding: 5px 10px; border-radius: 4px; color: var(--text); }

        #container { flex: 1; overflow-y: auto; padding: 20px; max-width: 800px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        /* Tarjetas */
        .card { background: var(--light); padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid var(--primary); cursor: pointer; }
        .card:hover { opacity: 0.8; }
        .card h3 { margin: 0; font-size: 1.1rem; }
        
        /* Grilla Botones */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .btn-cell { background: var(--light); padding: 15px; text-align: center; border-radius: 6px; font-weight: bold; border: 1px solid #ddd; cursor: pointer; }
        .btn-cell:hover { background: var(--primary); color: white; }

        /* Visor de Texto (Markdown simulado) */
        #viewer { font-family: var(--font); font-size: 1.1rem; line-height: 1.8; white-space: pre-wrap; }
        #viewer h1 { color: var(--primary); font-size: 1.5rem; margin-top: 30px; border-bottom: 1px solid #ccc; }
        #viewer h2 { color: var(--text); font-size: 1.2rem; margin-top: 25px; font-weight: bold; }
        #viewer strong { color: var(--primary); }
        
        .hidden { display: none; }
        
        /* Login */
        #login { position: fixed; inset: 0; background: var(--bg); z-index: 999; display: flex; align-items: center; justify-content: center; }
        .box { background: var(--light); padding: 30px; border-radius: 10px; text-align: center; width: 300px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .inp { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
        .act { width: 100%; padding: 10px; margin-top: 10px; background: var(--primary); color: white; border: none; font-weight: bold; }
    </style>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

    <div id="login">
        <div class="box">
            <h2 style="color:var(--primary)">Mi Estudio</h2>
            <input id="email" class="inp" type="email" placeholder="Email">
            <input id="pass" class="inp" type="password" placeholder="Contrase√±a">
            <button class="act" onclick="auth.login()">Entrar</button>
            <button class="act" style="background:#555" onclick="auth.reg()">Registrar</button>
            <p id="msg" style="color:red; font-size:0.8rem"></p>
        </div>
    </div>

    <div id="app" class="hidden">
        <header>
            <button onclick="nav.back()">‚¨Ö Men√∫</button>
            <h1 id="top-title">Biblioteca</h1>
            <button onclick="document.body.classList.toggle('dark-mode')">üåó</button>
        </header>

        <div id="container">
            <!-- PANTALLA 1: TRIMESTRES -->
            <div id="screen-q">
                <div class="card" onclick="nav.toLessons('2025-04', 'Josu√©')">
                    <h3>Lecciones de Josu√©</h3>
                    <small>4to Trimestre 2025</small>
                </div>
                <div class="card" onclick="nav.toLessons('2025-03', '√âxodo')">
                    <h3>El libro de √âxodo</h3>
                    <small>3er Trimestre 2025</small>
                </div>
                <div class="card" onclick="nav.toLessons('2025-02', 'Santuario')">
                    <h3>Cristo en el Santuario</h3>
                    <small>2do Trimestre 2025</small>
                </div>
            </div>

            <!-- PANTALLA 2: LECCIONES -->
            <div id="screen-l" class="hidden">
                <h3 style="text-align:center; margin-bottom:20px">Elige la Lecci√≥n</h3>
                <div class="grid" id="grid-lessons"></div>
            </div>

            <!-- PANTALLA 3: D√çAS -->
            <div id="screen-d" class="hidden">
                <h3 style="text-align:center; margin-bottom:20px">Elige el D√≠a</h3>
                <div class="grid">
                    <div class="btn-cell" onclick="reader.load('01')">S√°bado</div>
                    <div class="btn-cell" onclick="reader.load('02')">Domingo</div>
                    <div class="btn-cell" onclick="reader.load('03')">Lunes</div>
                    <div class="btn-cell" onclick="reader.load('04')">Martes</div>
                    <div class="btn-cell" onclick="reader.load('05')">Mi√©rcoles</div>
                    <div class="btn-cell" onclick="reader.load('06')">Jueves</div>
                    <div class="btn-cell" onclick="reader.load('07')">Viernes</div>
                </div>
            </div>

            <!-- PANTALLA 4: LECTOR -->
            <div id="screen-r" class="hidden">
                <div id="viewer"></div>
                <div style="margin-top:30px; text-align:center; border-top:1px solid #ccc; padding-top:10px;">
                    <button id="mark-btn" onclick="reader.toggle()" style="width:100%; padding:15px; font-weight:bold;">Marcar como Le√≠do</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyD8Z79dXBAIYXYYm-hvyJZszGiTiX1cdLk",
          authDomain: "miescuelasabatica-fdb06.firebaseapp.com",
          databaseURL: "https://miescuelasabatica-fdb06-default-rtdb.firebaseio.com",
          projectId: "miescuelasabatica-fdb06",
          storageBucket: "miescuelasabatica-fdb06.firebasestorage.app",
          messagingSenderId: "832420279762",
          appId: "1:832420279762:web:4218b0fa30e2e93b12c40b"
        };
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const fbDb = firebase.database();

        const state = { q:'', l:'', d:'', u:null };

        const auth = {
            login: () => fbAuth.signInWithEmailAndPassword(get('email'), get('pass')).catch(e=>msg(e.message)),
            reg: () => fbAuth.createUserWithEmailAndPassword(get('email'), get('pass')).catch(e=>msg(e.message))
        };
        function get(id){ return document.getElementById(id).value; }
        function msg(t){ document.getElementById('msg').innerText = t; }

        fbAuth.onAuthStateChanged(u => {
            if(u){
                state.u = u;
                document.getElementById('login').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            }
        });

        const nav = {
            toLessons: (qid, title) => {
                state.q = qid;
                document.getElementById('top-title').innerText = title;
                show('screen-l');
                
                let h = "";
                for(let i=1; i<=14; i++){
                    let n = i<10 ? "0"+i : i;
                    h += `<div class="btn-cell" onclick="nav.toDays('${n}')">Lecci√≥n ${n}</div>`;
                }
                document.getElementById('grid-lessons').innerHTML = h;
            },
            toDays: (lid) => {
                state.l = lid;
                document.getElementById('top-title').innerText = "Lecci√≥n " + lid;
                show('screen-d');
            },
            back: () => {
                if(!document.getElementById('screen-r').classList.contains('hidden')) show('screen-d');
                else if(!document.getElementById('screen-d').classList.contains('hidden')) show('screen-l');
                else show('screen-q');
            }
        };

        const reader = {
            load: async (did) => {
                state.d = did;
                show('screen-r');
                document.getElementById('viewer').innerHTML = '<p style="text-align:center">Descargando archivo original...</p>';
                
                // CHECK SYNC
                const ref = `users/${state.u.uid}/reads/${state.q}-${state.l}-${did}`;
                fbDb.ref(ref).on('value', s => {
                    let b = document.getElementById('mark-btn');
                    b.innerText = s.val() ? "‚úÖ LE√çDO" : "MARCAR LE√çDO";
                    b.style.background = s.val() ? "#ef5350" : "#fff";
                    b.style.color = s.val() ? "white" : "black";
                });

                // URL M√ÅGICA: RAW GITHUB MARKDOWN
                // Estructura: src/es/2025-04/09/06.md
                const url = `https://raw.githubusercontent.com/Adventech/sabbath-school-lessons/master/src/es/${state.q}/${state.l}/${did}.md`;
                
                try {
                    const r = await fetch(url);
                    if(!r.ok) throw new Error("Archivo no encontrado (404)");
                    let text = await r.text();
                    
                    // CONVERTIR MARKDOWN A HTML SIMPLE
                    // Eliminar metadatos del principio (--- ... ---)
                    text = text.replace(/^---[\s\S]*?---/, "");
                    
                    // Convertir T√≠tulos
                    text = text.replace(/^# (.*$)/gim, '<h1>$1</h1>');
                    text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                    text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                    
                    // Negritas y Citas
                    text = text.replace(/\*\*(.*)\*\*/gim, '<b>$1</b>');
                    text = text.replace(/> (.*$)/gim, '<blockquote>$1</blockquote>');
                    
                    document.getElementById('viewer').innerHTML = text;
                    
                } catch(e) {
                    document.getElementById('viewer').innerHTML = `<p style="color:red; text-align:center">
                        Error: No se encontr√≥ el texto.<br>
                        URL intentada: ${url}<br><br>
                        Verifica que la fecha coincida con la lecci√≥n seleccionada.
                    </p>`;
                }
            },
            toggle: () => {
                const ref = `users/${state.u.uid}/reads/${state.q}-${state.l}-${state.d}`;
                fbDb.ref(ref).once('value', s => fbDb.ref(ref).set(!s.val()));
            }
        };

        function show(id) {
            ['screen-q','screen-l','screen-d','screen-r'].forEach(x => document.getElementById(x).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
    </script>
</body>
</html>
