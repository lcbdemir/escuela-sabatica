<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escuela Sab√°tica V28 - Studio Pro</title>
    
    <!-- Fuente y Estilos -->
    <style>
        :root {
            --bg: #ffffff;
            --text: #222;
            --primary: #006064;
            --accent: #d81b60;
            --note-bg: #fffde7;
            --highlight-yellow: #ffeb3b;
            --highlight-green: #a5d6a7;
            --highlight-blue: #90caf9;
        }
        body.dark-mode {
            --bg: #121212;
            --text: #e0e0e0;
            --primary: #80cbc4;
            --accent: #f48fb1;
            --note-bg: #263238;
            --highlight-yellow: #fbc02d;
            --highlight-green: #388e3c;
            --highlight-blue: #1976d2;
        }
        body { font-family: 'Georgia', serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* BARRA DE NAVEGACI√ìN SUPERIOR */
        nav {
            background: var(--bg); border-bottom: 2px solid var(--primary); padding: 10px;
            display: flex; gap: 10px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }
        select {
            padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 0.9rem;
            background: var(--bg); color: var(--text); flex: 1;
        }
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; }

        /* √ÅREA DE CONTENIDO */
        #main { flex: 1; overflow-y: auto; padding: 20px; max-width: 800px; margin: 0 auto; width: 100%; position: relative; }
        
        /* ESTILOS DEL TEXTO */
        h1 { color: var(--primary); font-size: 1.6rem; border-bottom: 1px solid #ccc; margin-top: 0; }
        h2 { color: var(--text); font-size: 1.3rem; margin-top: 30px; font-weight: bold; }
        h3 { color: var(--accent); font-size: 1.1rem; margin-top: 20px; }
        p { line-height: 1.8; font-size: 1.1rem; margin-bottom: 15px; }
        strong { color: var(--primary); }
        blockquote { border-left: 4px solid var(--accent); padding-left: 15px; color: #555; font-style: italic; margin: 20px 0; }
        body.dark-mode blockquote { color: #aaa; }

        /* REFERENCIAS B√çBLICAS */
        .bible-ref { color: var(--accent); font-weight: bold; cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
        .bible-ref:hover { background-color: rgba(216, 27, 96, 0.1); }

        /* √ÅREA DE RESPUESTAS */
        .answer-box {
            width: 100%; border: 1px solid #ccc; background: var(--note-bg); color: var(--text);
            padding: 10px; border-radius: 8px; margin: 10px 0 20px 0; font-family: sans-serif;
            min-height: 60px; resize: vertical; box-sizing: border-box;
        }
        .answer-label { font-size: 0.8rem; color: var(--primary); font-weight: bold; margin-bottom: 5px; display: block; }

        /* MODAL BIBLIA */
        #bible-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content {
            background: var(--bg); width: 90%; max-width: 500px; max-height: 80%;
            border-radius: 10px; padding: 20px; overflow-y: auto; position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: var(--text); }

        /* MEN√ö FLOTANTE RESALTADO */
        #highlighter-menu {
            position: absolute; display: none; background: var(--bg);
            border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 5px; z-index: 500;
        }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; display: inline-block; margin: 0 5px; cursor: pointer; border: 1px solid #999; }

        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: var(--note-bg); padding: 30px; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .login-card input { display: block; width: 100%; margin: 10px 0; padding: 10px; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-card">
            <h2 style="color:var(--primary)">Mi Estudio</h2>
            <input id="email" type="email" placeholder="Email">
            <input id="pass" type="password" placeholder="Contrase√±a">
            <button class="btn-main" onclick="auth.login()">Ingresar</button>
            <button class="btn-main" style="background:#555; margin-top:5px" onclick="auth.reg()">Registrar</button>
            <p id="log-msg" style="color:red; font-size:0.8rem"></p>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app" style="display:none; flex-direction: column; height:100%">
        <!-- NAVEGACI√ìN R√ÅPIDA -->
        <nav>
            <select id="sel-quarter" onchange="nav.loadLessons()">
                <option value="2025-04">Josu√© (Actual)</option>
                <option value="2025-03">√âxodo</option>
                <option value="2025-02">Santuario</option>
                <option value="2025-01">Gran Conflicto</option>
            </select>
            <select id="sel-lesson" onchange="nav.updateDays()">
                <option>Lecci√≥n...</option>
            </select>
            <select id="sel-day" onchange="reader.loadContent()">
                <option>D√≠a...</option>
            </select>
            <button class="icon-btn" onclick="document.body.classList.toggle('dark-mode')" title="Modo Oscuro">üåó</button>
        </nav>

        <div id="main">
            <div id="content" onmouseup="highlighter.checkSelection()">
                <p style="text-align:center; padding-top:50px; color:#888">Selecciona una lecci√≥n arriba para empezar.</p>
            </div>
            
            <!-- MEN√ö RESALTADO -->
            <div id="highlighter-menu">
                <span class="color-dot" style="background:var(--highlight-yellow)" onclick="highlighter.apply('yellow')"></span>
                <span class="color-dot" style="background:var(--highlight-green)" onclick="highlighter.apply('green')"></span>
                <span class="color-dot" style="background:var(--highlight-blue)" onclick="highlighter.apply('blue')"></span>
                <span style="cursor:pointer; font-size:0.8rem; margin-left:5px" onclick="highlighter.clear()">‚ùå</span>
            </div>
        </div>
    </div>

    <!-- MODAL BIBLIA -->
    <div id="bible-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('bible-modal').style.display='none'">&times;</span>
            <h3 id="bible-title">Vers√≠culo</h3>
            <div id="bible-text">Cargando...</div>
            <div style="margin-top:15px; font-size:0.8rem; color:#666; text-align:center">
                <a id="bible-link" href="#" target="_blank" style="color:var(--primary)">Ver en BibleGateway</a>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyD8Z79dXBAIYXYYm-hvyJZszGiTiX1cdLk",
          authDomain: "miescuelasabatica-fdb06.firebaseapp.com",
          databaseURL: "https://miescuelasabatica-fdb06-default-rtdb.firebaseio.com",
          projectId: "miescuelasabatica-fdb06",
          storageBucket: "miescuelasabatica-fdb06.firebasestorage.app",
          messagingSenderId: "832420279762",
          appId: "1:832420279762:web:4218b0fa30e2e93b12c40b"
        };
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const fbDb = firebase.database();

        // ESTADO GLOBAL
        const state = { user: null, q: '2025-04', l: '01', d: '01' };

        // AUTH
        const auth = {
            login: () => fbAuth.signInWithEmailAndPassword(val('email'), val('pass')).catch(e => document.getElementById('log-msg').innerText = e.message),
            reg: () => fbAuth.createUserWithEmailAndPassword(val('email'), val('pass')).catch(e => document.getElementById('log-msg').innerText = e.message)
        };
        function val(id){ return document.getElementById(id).value; }

        fbAuth.onAuthStateChanged(u => {
            if(u){
                state.user = u;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                nav.init();
            }
        });

        // NAVEGACI√ìN
        const nav = {
            init: () => {
                nav.loadLessons();
            },
            loadLessons: () => {
                const sel = document.getElementById('sel-lesson');
                sel.innerHTML = "";
                for(let i=1; i<=14; i++){
                    let n = i<10 ? "0"+i : ""+i;
                    let opt = document.createElement('option');
                    opt.value = n;
                    opt.innerText = "Lecci√≥n " + n;
                    sel.appendChild(opt);
                }
                // Intentar seleccionar la lecci√≥n actual basada en fecha (aprox)
                // Por defecto la 1
                nav.updateDays();
            },
            updateDays: () => {
                const days = ["S√°bado", "Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes"];
                const codes = ["01", "02", "03", "04", "05", "06", "07"];
                const sel = document.getElementById('sel-day');
                sel.innerHTML = "";
                days.forEach((d, i) => {
                    let opt = document.createElement('option');
                    opt.value = codes[i];
                    opt.innerText = d;
                    sel.appendChild(opt);
                });
                reader.loadContent();
            }
        };

        // LECTOR E INTERACTIVIDAD
        const reader = {
            loadContent: async () => {
                state.q = document.getElementById('sel-quarter').value;
                state.l = document.getElementById('sel-lesson').value;
                state.d = document.getElementById('sel-day').value;
                
                const container = document.getElementById('content');
                container.innerHTML = '<p style="text-align:center; padding:50px">Cargando estudio...</p>';

                // 1. Descargar Raw Markdown desde GitHub
                const url = `https://raw.githubusercontent.com/Adventech/sabbath-school-lessons/master/src/es/${state.q}/${state.l}/${state.d}.md`;
                
                try {
                    const r = await fetch(url);
                    if(!r.ok) throw new Error("Lecci√≥n no disponible a√∫n.");
                    let text = await r.text();
                    
                    // 2. PROCESADOR DE TEXTO (Markdown -> HTML Interactivo)
                    let html = reader.processMarkdown(text);
                    container.innerHTML = html;

                    // 3. Restaurar Respuestas Guardadas
                    reader.loadAnswers();

                } catch(e) {
                    container.innerHTML = `<p style="color:red; text-align:center">Error: ${e.message}<br>Verifica que la lecci√≥n exista.</p>`;
                }
            },

            processMarkdown: (md) => {
                // Eliminar cabecera YAML
                md = md.replace(/^---[\s\S]*?---/, "");
                
                // T√≠tulos
                md = md.replace(/^# (.*$)/gim, '<h1>$1</h1>');
                md = md.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                md = md.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                
                // Negrita e It√°lica
                md = md.replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>');
                md = md.replace(/\*(.*)\*/gim, '<em>$1</em>');
                
                // Citas
                md = md.replace(/> (.*$)/gim, '<blockquote>$1</blockquote>');

                // REFERENCIAS B√çBLICAS (El truco m√°gico)
                // Busca patrones como "G√©n. 1:1" o "Juan 3:16"
                const bibleRegex = /([1-3]?\s?[A-Z][a-z√±√°√©√≠√≥√∫]+\.?\s\d+:\d+(-\d+)?)/g;
                md = md.replace(bibleRegex, '<span class="bible-ref" onclick="bible.open(\'$1\')">$1</span>');

                // PREGUNTAS Y CAMPOS DE RESPUESTA
                // Convertir saltos de l√≠nea
                let lines = md.split('\n');
                let html = "";
                
                lines.forEach((line, index) => {
                    if(line.trim() === "") return;
                    
                    // Si termina en ? o parece pregunta, a√±adir campo
                    // O si es un p√°rrafo normal, a√±adirlo
                    html += `<p>${line}</p>`;
                    
                    // L√≥gica simple: Si el p√°rrafo tiene signos de interrogaci√≥n o instruye leer, poner caja
                    if(line.includes('?') || line.includes('Lee') || line.includes('Comparte')) {
                        let id = `${state.q}-${state.l}-${state.d}-ans-${index}`;
                        html += `
                        <div>
                            <span class="answer-label">‚úçÔ∏è Tu Respuesta:</span>
                            <textarea id="${id}" class="answer-box" oninput="reader.saveAnswer('${id}')" placeholder="Escribe aqu√≠ tus pensamientos..."></textarea>
                        </div>`;
                    }
                });

                return html;
            },

            saveAnswer: (id) => {
                const val = document.getElementById(id).value;
                fbDb.ref(`users/${state.user.uid}/answers/${id}`).set(val);
            },

            loadAnswers: () => {
                // Cargar todas las respuestas de este d√≠a
                const prefix = `${state.q}-${state.l}-${state.d}`;
                fbDb.ref(`users/${state.user.uid}/answers`).once('value', s => {
                    const data = s.val();
                    if(data) {
                        Object.keys(data).forEach(key => {
                            if(key.startsWith(prefix)) {
                                const el = document.getElementById(key);
                                if(el) el.value = data[key];
                            }
                        });
                    }
                });
            }
        };

        // BIBLIA FLOTANTE
        const bible = {
            open: (ref) => {
                document.getElementById('bible-modal').style.display = 'flex';
                document.getElementById('bible-title').innerText = ref;
                document.getElementById('bible-text').innerHTML = '<p>Buscando...</p>';
                
                // Enlace externo por si acaso
                const link = `https://www.biblegateway.com/passage/?search=${encodeURIComponent(ref)}&version=RVR1960`;
                document.getElementById('bible-link').href = link;

                // Intento de API gratuita (Bible-API.com)
                // Nota: RVR no siempre est√° gratis en APIs p√∫blicas, usaremos una versi√≥n est√°ndar
                fetch(`https://bible-api.com/${encodeURIComponent(ref)}?translation=almeida`)
                    .then(r => r.json())
                    .then(data => {
                        if(data.text) {
                            document.getElementById('bible-text').innerText = data.text;
                        } else {
                            document.getElementById('bible-text').innerHTML = "No se pudo cargar el texto aqu√≠.<br>Usa el enlace de abajo.";
                        }
                    })
                    .catch(() => {
                        document.getElementById('bible-text').innerHTML = "Error de conexi√≥n con la Biblia.";
                    });
            }
        };

        // RESALTADOR SIMPLE
        const highlighter = {
            checkSelection: () => {
                const sel = window.getSelection();
                const menu = document.getElementById('highlighter-menu');
                if(sel.toString().length > 0) {
                    const range = sel.getRangeAt(0);
                    const rect = range.getBoundingClientRect();
                    menu.style.top = (rect.top + window.scrollY - 40) + 'px';
                    menu.style.left = rect.left + 'px';
                    menu.style.display = 'block';
                } else {
                    menu.style.display = 'none';
                }
            },
            apply: (color) => {
                const sel = window.getSelection();
                if(!sel.rangeCount) return;
                
                const range = sel.getRangeAt(0);
                const span = document.createElement('span');
                
                // Mapeo de colores
                let cCode = '';
                if(color === 'yellow') cCode = 'var(--highlight-yellow)';
                if(color === 'green') cCode = 'var(--highlight-green)';
                if(color === 'blue') cCode = 'var(--highlight-blue)';
                
                span.style.backgroundColor = cCode;
                span.appendChild(range.extractContents());
                range.insertNode(span);
                
                document.getElementById('highlighter-menu').style.display = 'none';
                
                // NOTA: Guardar resaltados HTML complejos en Firebase es muy dif√≠cil en un solo archivo.
                // Esta versi√≥n permite resaltar mientras lees, pero los resaltados podr√≠an no persistir al recargar
                // si no implementamos un sistema de serializaci√≥n DOM complejo. 
                // Por ahora, las RESPUESTAS escritas S√ç se guardan.
            },
            clear: () => {
                document.getElementById('highlighter-menu').style.display = 'none';
            }
        };
    </script>
</body>
</html>
