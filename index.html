<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escuela Sab√°tica V26 - Estructura Manual</title>
    
    <style>
        :root {
            --bg: #fdfbf7;
            --surface: #ffffff;
            --primary: #004d40;
            --text: #333;
            --border: #ddd;
        }
        body.dark-mode {
            --bg: #121212;
            --surface: #1e1e1e;
            --primary: #80cbc4;
            --text: #e0e0e0;
            --border: #333;
        }
        body { font-family: 'Georgia', serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        header { padding: 15px; background: var(--surface); border-bottom: 2px solid var(--primary); display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h1 { margin: 0; font-size: 1.1rem; color: var(--primary); font-weight: bold; }
        button { cursor: pointer; }
        .icon-btn { background: none; border: none; font-size: 1.4rem; padding: 0 10px; }

        #container { flex: 1; overflow-y: auto; padding: 15px; max-width: 800px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        /* Tarjetas de Trimestre */
        .card { background: var(--surface); padding: 20px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px; border-left: 5px solid var(--primary); }
        .card h3 { margin: 0 0 5px 0; color: var(--primary); }
        .card p { margin: 0; font-size: 0.9rem; opacity: 0.8; }

        /* Grilla de Lecciones */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .btn-item { background: var(--surface); border: 1px solid var(--border); padding: 15px; border-radius: 6px; text-align: center; font-weight: bold; }
        .btn-item:hover { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Lectura */
        #reader { line-height: 1.8; font-size: 19px; }
        #reader h2 { color: var(--primary); border-bottom: 1px solid var(--border); margin-top: 30px; }
        #reader p { margin-bottom: 1.5em; }

        /* Login */
        #login { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 999; }
        .login-box { background: var(--surface); padding: 30px; border-radius: 12px; width: 300px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .inp { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; }
        .act-btn { width: 100%; padding: 12px; margin-top: 5px; border: none; border-radius: 4px; font-weight: bold; color: white; background: var(--primary); }

        .nav-bar { background: var(--surface); padding: 15px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; }
        .hidden { display: none !important; }
    </style>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

    <!-- LOGIN -->
    <div id="login">
        <div class="login-box">
            <h2 style="color:var(--primary)">Mi Estudio</h2>
            <input id="email" class="inp" type="email" placeholder="Email">
            <input id="pass" class="inp" type="password" placeholder="Contrase√±a">
            <button class="act-btn" onclick="auth.login()">Entrar</button>
            <button class="act-btn" style="background:#555; margin-top:10px" onclick="auth.reg()">Crear Cuenta</button>
            <p id="msg" style="color:red; font-size:0.8rem"></p>
        </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
        <header>
            <button class="icon-btn" onclick="nav.back()">‚¨Ö</button>
            <h1 id="title">Biblioteca</h1>
            <button class="icon-btn" onclick="ui.mode()">üåó</button>
        </header>

        <div id="container">
            <!-- VISTAS -->
            <div id="view-quarters"></div>
            <div id="view-lessons" class="hidden"></div>
            <div id="view-days" class="hidden"></div>
            <div id="view-reader" class="hidden">
                <div id="reader-content"></div>
                <div id="status" style="text-align:center; color:#999; margin-top:20px; font-size:0.8rem"></div>
            </div>
        </div>

        <footer id="footer" class="hidden">
            <div class="nav-bar">
                <button class="act-btn" style="width:auto" onclick="reader.prev()">Ant</button>
                <button id="mark-btn" class="act-btn" style="width:auto; background:#888" onclick="reader.mark()">Marcar</button>
                <button class="act-btn" style="width:auto" onclick="reader.next()">Sig</button>
            </div>
        </footer>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
          apiKey: "AIzaSyD8Z79dXBAIYXYYm-hvyJZszGiTiX1cdLk",
          authDomain: "miescuelasabatica-fdb06.firebaseapp.com",
          databaseURL: "https://miescuelasabatica-fdb06-default-rtdb.firebaseio.com",
          projectId: "miescuelasabatica-fdb06",
          storageBucket: "miescuelasabatica-fdb06.firebasestorage.app",
          messagingSenderId: "832420279762",
          appId: "1:832420279762:web:4218b0fa30e2e93b12c40b"
        };
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const fbDb = firebase.database();

        // DATOS MANUALES (V26)
        const QUARTERS = [
            { id: "2025-04", title: "Lecciones de Josu√©", desc: "Oct-Dic 2025" },
            { id: "2025-03", title: "El libro de √âxodo", desc: "Jul-Sep 2025" },
            { id: "2025-02", title: "Cristo en el Santuario", desc: "Abr-Jun 2025" },
            { id: "2025-01", title: "El Gran Conflicto", desc: "Ene-Mar 2025" }
        ];

        // ESTADO
        const state = { user: null, qId: null, lId: null, dId: null };

        // AUTH
        const auth = {
            login: () => fbAuth.signInWithEmailAndPassword(val('email'), val('pass')).catch(e=>msg(e.message)),
            reg: () => fbAuth.createUserWithEmailAndPassword(val('email'), val('pass')).catch(e=>msg(e.message))
        };
        function val(id){ return document.getElementById(id).value; }
        function msg(t){ document.getElementById('msg').innerText = t; }

        fbAuth.onAuthStateChanged(u => {
            if(u){
                state.user = u;
                document.getElementById('login').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                nav.home();
            }
        });

        // NAVEGACI√ìN
        const nav = {
            home: () => {
                ui.show('view-quarters');
                document.getElementById('title').innerText = "Biblioteca";
                let h = "";
                QUARTERS.forEach(q => {
                    h += `<div class="card" onclick="nav.lessons('${q.id}', '${q.title}')">
                        <h3>${q.title}</h3><p>${q.desc}</p></div>`;
                });
                document.getElementById('view-quarters').innerHTML = h;
            },
            lessons: (qid, title) => {
                state.qId = qid;
                ui.show('view-lessons');
                document.getElementById('title').innerText = title;
                
                // GENERAR 14 LECCIONES AUTOM√ÅTICAMENTE (Sin preguntar a la API)
                let h = '<div class="grid">';
                for(let i=1; i<=14; i++) {
                    let num = i < 10 ? "0"+i : i; // 01, 02...
                    h += `<div class="btn-item" onclick="nav.days('${num}')">Lecci√≥n ${num}</div>`;
                }
                h += '</div>';
                document.getElementById('view-lessons').innerHTML = h;
            },
            days: (lid) => {
                state.lId = lid;
                ui.show('view-days');
                document.getElementById('title').innerText = `Lecci√≥n ${lid}`;
                
                // GENERAR 7 D√çAS AUTOM√ÅTICAMENTE
                let names = ["S√°bado", "Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes"];
                let codes = ["01", "02", "03", "04", "05", "06", "07"];
                
                let h = '<div class="grid">';
                names.forEach((name, i) => {
                    h += `<div class="btn-item" onclick="reader.load('${codes[i]}')">${name}</div>`;
                });
                h += '</div>';
                document.getElementById('view-days').innerHTML = h;
            },
            back: () => {
                if(!document.getElementById('view-reader').classList.contains('hidden')) nav.days(state.lId);
                else if(!document.getElementById('view-days').classList.contains('hidden')) nav.lessons(state.qId, "Lecciones");
                else nav.home();
            }
        };

        // LECTOR (Aqu√≠ es donde finalmente conectamos)
        const reader = {
            load: async (did) => {
                state.dId = did;
                ui.show('view-reader');
                document.getElementById('footer').classList.remove('hidden');
                document.getElementById('reader-content').innerHTML = '<p style="text-align:center; padding:50px">Cargando texto...</p>';
                
                // CHECK FIREBASE
                const ref = `users/${state.user.uid}/reads/${state.qId}-${state.lId}-${did}`;
                fbDb.ref(ref).on('value', s => {
                    let btn = document.getElementById('mark-btn');
                    btn.innerText = s.val() ? "‚úÖ Le√≠do" : "Marcar";
                    btn.style.background = s.val() ? "#27ae60" : "#888";
                });

                // INTENTO DE DESCARGA (API PROXY)
                const api = `https://sabbath-school.adventech.io/api/v1/es/quarterlies/${state.qId}/lessons/${state.lId}/days/${did}/read/index.json`;
                const proxy = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(api)}`;
                
                try {
                    let r = await fetch(proxy);
                    let json = await r.json();
                    document.getElementById('reader-content').innerHTML = json.content;
                    document.getElementById('status').innerText = "Fuente: CodeTabs Proxy";
                } catch(e) {
                    // INTENTO 2: CorsProxy
                    try {
                        let p2 = `https://corsproxy.io/?${encodeURIComponent(api)}`;
                        let r2 = await fetch(p2);
                        let json2 = await r2.json();
                        document.getElementById('reader-content').innerHTML = json2.content;
                        document.getElementById('status').innerText = "Fuente: CorsProxy";
                    } catch(err) {
                        document.getElementById('reader-content').innerHTML = `
                        <div style="text-align:center; color:red; padding:20px">
                            <p>No se pudo cargar el texto de este d√≠a.</p>
                            <p>Es posible que el ID de la lecci√≥n no sea "${state.lId}".</p>
                            <p>Prueba con otra lecci√≥n de la lista.</p>
                        </div>`;
                    }
                }
            },
            mark: () => {
                const ref = `users/${state.user.uid}/reads/${state.qId}-${state.lId}-${state.dId}`;
                fbDb.ref(ref).once('value', s => fbDb.ref(ref).set(!s.val()));
            },
            prev: () => {
                let n = parseInt(state.dId) - 1;
                if(n>0) reader.load(n < 10 ? "0"+n : ""+n);
            },
            next: () => {
                let n = parseInt(state.dId) + 1;
                if(n<=7) reader.load(n < 10 ? "0"+n : ""+n);
            }
        };

        const ui = {
            show: (id) => {
                ['view-quarters','view-lessons','view-days','view-reader'].forEach(x => document.getElementById(x).classList.add('hidden'));
                document.getElementById('footer').classList.add('hidden');
                document.getElementById(id).classList.remove('hidden');
            },
            mode: () => document.body.classList.toggle('dark-mode')
        };
    </script>
</body>
</html>
