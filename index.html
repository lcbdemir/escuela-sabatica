<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Escuela Sab√°tica V42 - Carga Inmediata</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root { --bg:#fff; --text:#222; --primary:#00695c; --acc:#c62828; --sec:#e0f2f1; }
        body.sepia { --bg:#f4ecd8; --text:#5b4636; --primary:#5d4037; --sec:#eefebe; }
        body.dark { --bg:#121212; --text:#e0e0e0; --primary:#80cbc4; --sec:#1e1e1e; --acc:#ef9a9a; }
        body { font-family:'Georgia',serif; margin:0; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; }
        
        header { background:var(--sec); padding:10px; border-bottom:2px solid var(--primary); display:flex; gap:5px; align-items:center; z-index:50; }
        select { flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:16px; background:var(--bg); color:var(--text); }
        .btn { background:none; border:1px solid #ccc; padding:5px; border-radius:4px; color:var(--text); cursor:pointer; }
        
        #main { flex:1; overflow-y:auto; padding:20px 40px; position:relative; scroll-behavior:smooth; }
        .arrow { position:fixed; top:50%; transform:translateY(-50%); font-size:2rem; padding:15px 5px; background:rgba(0,0,0,0.1); border:none; cursor:pointer; z-index:40; color:var(--text); }
        .arrow:hover { background:var(--primary); color:white; }
        
        h1 { color:var(--primary); border-bottom:1px solid #ccc; }
        .bible { color:var(--primary); font-weight:bold; text-decoration:underline; cursor:pointer; }
        .note { font-size:0.7em; vertical-align:super; cursor:pointer; color:var(--acc); text-decoration:none; }
        .note::before { content:'üìÑ'; }
        
        .box { width:100%; min-height:100px; padding:10px; margin:15px 0; border:1px solid #ccc; background:var(--bg); color:var(--text); overflow:auto; }
        
        /* CINTA */
        #ribbon { position:absolute; display:none; background:#333; padding:5px; border-radius:50px; z-index:1000; gap:5px; }
        .rib-btn { background:none; border:none; color:white; padding:8px; cursor:pointer; display:flex; border-radius:50%; }
        .rib-btn:hover { background:#555; }
        
        /* MODALES */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:2000; }
        .m-box { background:var(--bg); padding:20px; border-radius:8px; width:90%; max-width:500px; max-height:80%; display:flex; flex-direction:column; }
        
        .hidden { display:none!important; }
    </style>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

    <header>
        <select id="sq" onchange="app.load()"></select>
        <select id="sl" onchange="app.load()"></select>
        <select id="sd" onchange="app.load()"></select>
        <button class="btn" onclick="ui.theme()">üé®</button>
        <button class="btn" onclick="ui.font(2)">A+</button>
        <button class="btn" onclick="ui.font(-2)">A-</button>
        <button id="btn-login" class="btn" onclick="auth.ui()" style="color:var(--primary)">üë§</button>
    </header>

    <button class="arrow" style="left:0" onclick="nav.move(-1)">‚ùÆ</button>
    <button class="arrow" style="right:0" onclick="nav.move(1)">‚ùØ</button>

    <div id="main" onmouseup="ribbon.show()" ontouchend="ribbon.show()">
        <div id="content"><p style="text-align:center; margin-top:50px">Iniciando...</p></div>
    </div>

    <!-- CINTA -->
    <div id="ribbon" onmousedown="event.preventDefault()">
        <button class="rib-btn" onclick="fmt.bg('yellow')" style="background:yellow; border:1px solid #fff"></button>
        <button class="rib-btn" onclick="fmt.bg('#a5d6a7')" style="background:#a5d6a7; border:1px solid #fff"></button>
        <button class="rib-btn" onclick="fmt.bg('#90caf9')" style="background:#90caf9; border:1px solid #fff"></button>
        <div style="width:1px; height:20px; background:#666"></div>
        <button class="rib-btn" onclick="fmt.addNote()">üìù</button>
        <button class="rib-btn" onclick="fmt.clear()">üßπ</button>
    </div>

    <!-- LOGIN -->
    <div id="login-m" class="modal">
        <div class="m-box" style="text-align:center">
            <h3>Acceso</h3>
            <input id="em" type="email" placeholder="Email" style="width:100%; padding:10px; margin:5px 0">
            <input id="pw" type="password" placeholder="Pass" style="width:100%; padding:10px; margin:5px 0">
            <button onclick="auth.go(true)" style="padding:10px; width:100%; background:var(--primary); color:white; border:none; margin-top:10px">Entrar / Registrar</button>
            <button onclick="document.getElementById('login-m').style.display='none'" style="margin-top:10px; background:none; border:none">Cerrar</button>
        </div>
    </div>

    <!-- NOTA -->
    <div id="note-m" class="modal">
        <div class="m-box">
            <div style="display:flex; justify-content:space-between"><b>Nota</b> <button onclick="notes.close()">‚úï</button></div>
            <div id="note-ed" class="box" contenteditable="true"></div>
            <div style="display:flex; justify-content:space-between">
                <button onclick="notes.del()" style="background:#c62828; color:white; border:none; padding:8px">Eliminar</button>
                <button onclick="notes.save()" style="background:var(--primary); color:white; border:none; padding:8px">Guardar</button>
            </div>
        </div>
    </div>

    <!-- BIBLIA -->
    <div id="bible-m" class="modal">
        <div class="m-box" style="height:80%; max-width:600px">
            <div style="text-align:right"><button onclick="document.getElementById('bible-m').style.display='none'">‚úï</button></div>
            <iframe id="bible-fr" style="flex:1; border:none"></iframe>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyD8Z79dXBAIYXYYm-hvyJZszGiTiX1cdLk", authDomain: "miescuelasabatica-fdb06.firebaseapp.com", databaseURL: "https://miescuelasabatica-fdb06-default-rtdb.firebaseio.com", projectId: "miescuelasabatica-fdb06", storageBucket: "miescuelasabatica-fdb06.firebasestorage.app", messagingSenderId: "832420279762", appId: "1:832420279762:web:4218b0fa30e2e93b12c40b" };
        try { firebase.initializeApp(firebaseConfig); } catch(e){}
        const fbAuth = firebase.auth();
        const fbDb = firebase.database();

        let user = null;
        let activeNote = null;

        // INICIO INMEDIATO
        window.onload = () => {
            nav.init(); // Cargar men√∫s
            app.load(); // Cargar texto (sin esperar login)
            
            // Escuchar login en segundo plano
            fbAuth.onAuthStateChanged(u => {
                user = u;
                document.getElementById('btn-login').style.color = u ? '#4caf50' : 'var(--primary)';
                if(u) app.loadSaved(); // Si entra, cargar sus datos
            });
        };

        const nav = {
            init: () => {
                const add = (id, txt, val) => {
                    let o = document.createElement('option'); o.text=txt; o.value=val;
                    document.getElementById(id).add(o);
                };
                add('sq','Josu√©','2025-04'); add('sq','√âxodo','2025-03');
                for(let i=1; i<=14; i++) add('sl', 'Lecci√≥n '+i, i<10?"0"+i:""+i);
                ['S√°bado','Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes'].forEach((d,i)=> add('sd', d, "0"+(i+1)));
                
                // Fecha hoy
                document.getElementById('sl').value = "09";
                document.getElementById('sd').value = "0" + (new Date().getDay() || 7);
            },
            move: (d) => {
                let s = document.getElementById('sd');
                if(s.selectedIndex + d >= 0 && s.selectedIndex + d < s.options.length) {
                    s.selectedIndex += d; app.load();
                }
            }
        };

        const app = {
            load: async () => {
                const q = document.getElementById('sq').value;
                const l = document.getElementById('sl').value;
                const d = document.getElementById('sd').value;
                const url = `https://raw.githubusercontent.com/Adventech/sabbath-school-lessons/master/src/es/${q}/${l}/${d}.md`;
                
                document.getElementById('content').innerHTML = '<p style="text-align:center; margin-top:50px">Cargando...</p>';
                
                try {
                    let r = await fetch(url);
                    if(!r.ok) throw new Error();
                    let txt = await r.text();
                    document.getElementById('content').innerHTML = parser(txt);
                    if(user) app.loadSaved(); // Restaurar si hay usuario
                } catch(e) {
                    document.getElementById('content').innerHTML = '<p style="text-align:center">No disponible.</p>';
                }
            },
            loadSaved: () => {
                if(!user) return;
                const path = `users/${user.uid}/${document.getElementById('sq').value}-${document.getElementById('sl').value}-${document.getElementById('sd').value}`;
                
                // 1. Cargar HTML completo guardado
                fbDb.ref(path + '/html').once('value', s => {
                    if(s.val()) {
                        document.getElementById('content').innerHTML = s.val();
                        // Reconectar eventos
                        document.querySelectorAll('.bible').forEach(e => e.onclick = () => bible(e.innerText));
                        document.querySelectorAll('.note').forEach(e => e.onclick = (ev) => { ev.stopPropagation(); notes.open(e.dataset.id); });
                    }
                });
                
                // 2. Cargar Inputs
                fbDb.ref(path + '/inputs').once('value', s => {
                    if(s.val()) Object.keys(s.val()).forEach(k => {
                        let el = document.getElementById(k);
                        if(el) el.innerHTML = s.val()[k];
                    });
                });
            },
            save: () => {
                if(!user) return;
                const path = `users/${user.uid}/${document.getElementById('sq').value}-${document.getElementById('sl').value}-${document.getElementById('sd').value}`;
                fbDb.ref(path + '/html').set(document.getElementById('content').innerHTML);
            },
            saveInput: (id, val) => {
                if(!user) return;
                const path = `users/${user.uid}/${document.getElementById('sq').value}-${document.getElementById('sl').value}-${document.getElementById('sd').value}`;
                fbDb.ref(path + '/inputs/' + id).set(val);
            }
        };

        const parser = (md) => {
            md = md.replace(/^---[\s\S]*?---/, "")
                   .replace(/^# (.*)/gm, '<h1>$1</h1>')
                   .replace(/^## (.*)/gm, '<h2>$1</h2>')
                   .replace(/^### (.*)/gm, '<h3>$1</h3>')
                   .replace(/\*\*(.*)\*\*/gm, '<b>$1</b>')
                   .replace(/([1-3]? ?[A-Z√ë][a-z√±]+\.? \d+:\d+(?:-\d+)?)/g, '<span class="bible" onclick="bible(\'$1\')">$1</span>');
            
            let html = "";
            md.split('\n').forEach((line, i) => {
                if(line.trim()) {
                    html += `<p>${line}</p>`;
                    if(line.includes('?') || line.includes('Lee')) {
                        html += `<div id="ans-${i}" class="box" contenteditable="true" onblur="app.saveInput('ans-${i}', this.innerHTML)"></div>`;
                    }
                }
            });
            return html;
        };

        const fmt = {
            bg: (c) => { document.execCommand('BackColor',false,c); app.save(); },
            addNote: () => {
                let id = Date.now();
                let s = document.createElement('sup'); s.className='note'; s.dataset.id=id; 
                s.contentEditable="false"; s.onclick=(e)=>{e.stopPropagation(); notes.open(id)};
                window.getSelection().getRangeAt(0).insertNode(s);
                notes.open(id); app.save();
            },
            clear: () => { document.execCommand('removeFormat'); app.save(); }
        };

        const notes = {
            open: (id) => {
                activeNote = id;
                document.getElementById('note-m').style.display = 'flex';
                if(user) fbDb.ref(`users/${user.uid}/notes/${id}`).once('value', s => document.getElementById('note-ed').innerHTML = s.val() || "");
            },
            save: () => {
                if(user) fbDb.ref(`users/${user.uid}/notes/${activeNote}`).set(document.getElementById('note-ed').innerHTML);
                document.getElementById('note-m').style.display = 'none';
            },
            del: () => {
                if(user) fbDb.ref(`users/${user.uid}/notes/${activeNote}`).remove();
                let el = document.querySelector(`.note[data-id="${activeNote}"]`);
                if(el) el.remove();
                document.getElementById('note-m').style.display = 'none';
                app.save();
            },
            close: () => document.getElementById('note-m').style.display = 'none'
        };

        const bible = (ref) => {
            document.getElementById('bible-m').style.display = 'flex';
            document.getElementById('bible-fr').src = `https://www.biblegateway.com/passage/?search=${encodeURIComponent(ref)}&version=RVR1960`;
        };

        const auth = {
            ui: () => document.getElementById('login-m').style.display = 'flex',
            go: (isReg) => {
                let e = document.getElementById('em').value, p = document.getElementById('pw').value;
                fbAuth.signInWithEmailAndPassword(e,p).catch(() => fbAuth.createUserWithEmailAndPassword(e,p))
                .then(() => document.getElementById('login-m').style.display = 'none');
            }
        };

        const ribbon = {
            show: () => {
                setTimeout(() => {
                    let sel = window.getSelection();
                    if(!sel.isCollapsed) {
                        let r = sel.getRangeAt(0).getBoundingClientRect();
                        let rib = document.getElementById('ribbon');
                        rib.style.display = 'flex';
                        rib.style.top = (r.top + window.scrollY - 50) + 'px';
                        rib.style.left = r.left + 'px';
                    }
                }, 100);
            }
        };

        const ui = {
            theme: () => document.body.classList.toggle('sepia'),
            font: (v) => {
                let el = document.getElementById('content');
                el.style.fontSize = (parseInt(window.getComputedStyle(el).fontSize) + v) + 'px';
            }
        };
    </script>
</body>
</html>
