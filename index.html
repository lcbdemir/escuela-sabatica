<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudio B칤blico V29 - Completo</title>
    <!-- Iconos -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --bg: #ffffff;
            --text: #333;
            --primary: #004d40;
            --secondary: #e0f2f1;
            --accent: #c62828;
            --highlight-yellow: #ffeb3b;
            --highlight-green: #a5d6a7;
            --highlight-blue: #90caf9;
            --highlight-orange: #ffcc80;
            --highlight-purple: #ce93d8;
        }
        body.dark-mode {
            --bg: #121212;
            --text: #e0e0e0;
            --primary: #80cbc4;
            --secondary: #263238;
            --accent: #ef9a9a;
        }
        body { font-family: 'Merriweather', serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER & NAV */
        header { background: var(--secondary); padding: 10px; border-bottom: 2px solid var(--primary); display: flex; flex-direction: column; gap: 10px; z-index: 100; }
        .nav-row { display: flex; gap: 5px; justify-content: space-between; }
        select { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 16px; background: var(--bg); color: var(--text); }
        .btn-icon { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text); display: flex; align-items: center; }

        /* TOOLBAR (HERRAMIENTAS) */
        .toolbar { display: flex; gap: 10px; align-items: center; overflow-x: auto; padding-bottom: 5px; }
        .color-btn { width: 25px; height: 25px; border-radius: 50%; border: 1px solid #999; cursor: pointer; flex-shrink: 0; }
        .toolbar label { font-size: 0.8rem; font-family: sans-serif; font-weight: bold; margin-right: 5px; }

        /* AREA DE CONTENIDO */
        #main-container { flex: 1; overflow-y: auto; padding: 20px; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box; position: relative; }
        
        /* TEXTO DE LA LECCI칍N */
        #content h1 { font-size: 1.8rem; color: var(--primary); margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        #content h2 { font-size: 1.4rem; color: var(--text); margin-top: 30px; }
        #content h3 { font-size: 1.2rem; color: var(--accent); margin-top: 20px; font-weight: bold; }
        #content p { line-height: 1.8; font-size: 1.15rem; margin-bottom: 15px; }
        #content blockquote { border-left: 4px solid var(--primary); margin: 20px 0; padding-left: 20px; color: #666; font-style: italic; background: rgba(0,0,0,0.02); padding: 10px; }
        
        /* ENLACES B칈BLICOS */
        .bible-ref { color: var(--primary); font-weight: bold; text-decoration: underline; cursor: pointer; background: rgba(0, 77, 64, 0.1); padding: 0 4px; border-radius: 3px; }
        .bible-ref:hover { background: var(--primary); color: white; }

        /* CAJAS DE RESPUESTA */
        .input-group { margin: 20px 0; }
        .input-label { font-family: sans-serif; font-size: 0.9rem; font-weight: bold; color: var(--accent); margin-bottom: 5px; display: block; }
        textarea.user-note {
            width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 8px;
            font-family: sans-serif; font-size: 1rem; background: #fffde7; color: #333; resize: vertical;
            box-sizing: border-box;
        }
        body.dark-mode textarea.user-note { background: #37474f; color: #fff; border-color: #555; }

        /* MODAL BIBLIA */
        #bible-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-body {
            background: white; width: 95%; max-width: 600px; height: 80%; border-radius: 8px;
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        .modal-header { padding: 10px; background: var(--secondary); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; }
        .close-btn { font-size: 1.5rem; cursor: pointer; background: none; border: none; font-weight: bold;}
        iframe { flex: 1; border: none; width: 100%; }

        /* LOGIN */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; align-items: center; justify-content: center; }
        .card { background: var(--secondary); padding: 40px; border-radius: 12px; width: 300px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .card input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 4px; border: 1px solid #999; box-sizing: border-box; }
        .btn-log { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 5px;}
    </style>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

    <!-- PANTALLA DE ACCESO -->
    <div id="login-screen">
        <div class="card">
            <h2 style="color:var(--primary)">Mi Estudio</h2>
            <input id="email" type="email" placeholder="Correo electr칩nico">
            <input id="pass" type="password" placeholder="Contrase침a">
            <button class="btn-log" onclick="auth.login()">Iniciar Sesi칩n</button>
            <button class="btn-log" style="background:#555" onclick="auth.register()">Crear Cuenta</button>
            <p id="msg" style="color:red; margin-top:10px; font-size:0.8rem"></p>
        </div>
    </div>

    <!-- PANTALLA PRINCIPAL -->
    <div id="app" style="display:none">
        <header>
            <!-- L칤nea 1: Navegaci칩n -->
            <div class="nav-row">
                <select id="q-sel" onchange="nav.loadLessons()">
                    <option value="2025-04">Josu칠 (2025-04)</option>
                    <option value="2025-03">칄xodo (2025-03)</option>
                    <option value="2025-02">Santuario (2025-02)</option>
                    <option value="2025-01">Gran Conflicto (2025-01)</option>
                </select>
                <select id="l-sel" onchange="nav.updateDays()">
                    <option>Lecci칩n...</option>
                </select>
                <select id="d-sel" onchange="reader.load()">
                    <option>D칤a...</option>
                </select>
            </div>
            
            <!-- L칤nea 2: Herramientas -->
            <div class="nav-row toolbar">
                <button class="btn-icon" onclick="ui.theme()" title="Modo Oscuro">游깽</button>
                <button class="btn-icon" onclick="ui.font(2)" title="Aumentar Letra">A+</button>
                <button class="btn-icon" onclick="ui.font(-2)" title="Disminuir Letra">A-</button>
                
                <div style="width:1px; height:20px; background:#ccc; margin:0 5px;"></div>
                <label>Resaltar:</label>
                <div class="color-btn" style="background:var(--highlight-yellow)" onclick="highlighter.color('yellow')"></div>
                <div class="color-btn" style="background:var(--highlight-green)" onclick="highlighter.color('green')"></div>
                <div class="color-btn" style="background:var(--highlight-blue)" onclick="highlighter.color('blue')"></div>
                <div class="color-btn" style="background:var(--highlight-orange)" onclick="highlighter.color('orange')"></div>
                <div class="color-btn" style="background:var(--highlight-purple)" onclick="highlighter.color('purple')"></div>
            </div>
        </header>

        <div id="main-container">
            <div id="content">
                <p style="text-align:center; padding-top:50px; color:#888">
                    Selecciona una lecci칩n arriba para comenzar.
                </p>
            </div>
        </div>
    </div>

    <!-- VISOR DE BIBLIA (IFRAME) -->
    <div id="bible-modal">
        <div class="modal-body">
            <div class="modal-header">
                <span id="bible-header-title" style="font-weight:bold">Santa Biblia</span>
                <button class="close-btn" onclick="document.getElementById('bible-modal').style.display='none'">&times;</button>
            </div>
            <iframe id="bible-frame" src=""></iframe>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI칍N FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyD8Z79dXBAIYXYYm-hvyJZszGiTiX1cdLk",
          authDomain: "miescuelasabatica-fdb06.firebaseapp.com",
          databaseURL: "https://miescuelasabatica-fdb06-default-rtdb.firebaseio.com",
          projectId: "miescuelasabatica-fdb06",
          storageBucket: "miescuelasabatica-fdb06.firebasestorage.app",
          messagingSenderId: "832420279762",
          appId: "1:832420279762:web:4218b0fa30e2e93b12c40b"
        };
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const fbDb = firebase.database();

        // Estado Global
        const state = { user: null, q: '2025-04', l: '01', d: '01' };

        // --- 2. AUTENTICACI칍N ---
        const auth = {
            login: () => fbAuth.signInWithEmailAndPassword(val('email'), val('pass')).catch(e => msg(e.message)),
            reg: () => fbAuth.createUserWithEmailAndPassword(val('email'), val('pass')).catch(e => msg(e.message))
        };
        function val(id){ return document.getElementById(id).value; }
        function msg(t){ document.getElementById('msg').innerText = t; }

        fbAuth.onAuthStateChanged(u => {
            if(u){
                state.user = u;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                nav.init();
            }
        });

        // --- 3. NAVEGACI칍N (MEN칔S DESPLEGABLES) ---
        const nav = {
            init: () => {
                nav.loadLessons();
            },
            loadLessons: () => {
                const sel = document.getElementById('l-sel');
                sel.innerHTML = "";
                // Crear 14 lecciones
                for(let i=1; i<=14; i++){
                    let n = i<10 ? "0"+i : ""+i;
                    let opt = document.createElement('option');
                    opt.value = n;
                    opt.innerText = "Lecci칩n " + n;
                    sel.appendChild(opt);
                }
                nav.updateDays();
            },
            updateDays: () => {
                const days = ["S치bado", "Domingo", "Lunes", "Martes", "Mi칠rcoles", "Jueves", "Viernes"];
                const codes = ["01", "02", "03", "04", "05", "06", "07"];
                const sel = document.getElementById('d-sel');
                sel.innerHTML = "";
                days.forEach((d, i) => {
                    let opt = document.createElement('option');
                    opt.value = codes[i];
                    opt.innerText = d;
                    sel.appendChild(opt);
                });
                reader.load();
            }
        };

        // --- 4. LECTOR Y PROCESADOR DE TEXTO ---
        const reader = {
            load: async () => {
                // Actualizar estado desde selectores
                state.q = document.getElementById('q-sel').value;
                state.l = document.getElementById('l-sel').value;
                state.d = document.getElementById('d-sel').value;

                const area = document.getElementById('content');
                area.innerHTML = '<p style="text-align:center; margin-top:50px">Cargando lecci칩n...</p>';

                // URL GITHUB RAW (Infalible)
                const url = `https://raw.githubusercontent.com/Adventech/sabbath-school-lessons/master/src/es/${state.q}/${state.l}/${state.d}.md`;

                try {
                    const r = await fetch(url);
                    if(!r.ok) throw new Error("Texto no encontrado (404)");
                    let md = await r.text();
                    
                    // Procesar Markdown a HTML Interactivo
                    area.innerHTML = markdownParser(md);
                    
                    // Cargar notas guardadas
                    notes.load();

                } catch(e) {
                    area.innerHTML = `<p style="color:red; text-align:center">No se encontr칩 la lecci칩n ${state.l} del d칤a ${state.d} en el trimestre ${state.q}.</p>`;
                }
            }
        };

        // --- 5. PARSER AVANZADO (MARKDOWN -> HTML + INTERACTIVIDAD) ---
        function markdownParser(text) {
            // Eliminar cabecera
            text = text.replace(/^---[\s\S]*?---/, "");

            // T칤tulos
            text = text.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');

            // Formato b치sico
            text = text.replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>');
            text = text.replace(/\*(.*)\*/gim, '<em>$1</em>');
            text = text.replace(/> (.*$)/gim, '<blockquote>$1</blockquote>');

            // --- DETECTOR DE CITAS B칈BLICAS ---
            // Regex mejorado para capturar libros, cap칤tulos y vers칤culos
            text = text.replace(/([1-3]?\s?[A-Z칌][a-z침치칠칤칩칰]+\.?\s\d+:\d+(?:-\d+)?)/g, 
                '<span class="bible-ref" onclick="bible.open(\'$1\')">$1</span>');

            // --- INYECTOR DE PREGUNTAS ---
            // Divide por p치rrafos
            let paragraphs = text.split('\n\n');
            let html = "";
            
            paragraphs.forEach((p, index) => {
                if(!p.trim()) return;
                html += `<p>${p}</p>`;
                
                // Si el p치rrafo tiene pregunta, a침adir caja de texto
                if(p.includes('?') || p.includes('Lee') || p.includes('Comparte')) {
                    let id = `note-${state.q}-${state.l}-${state.d}-${index}`;
                    html += `
                    <div class="input-group">
                        <label class="input-label">游닇 Tus notas:</label>
                        <textarea id="${id}" class="user-note" oninput="notes.save('${id}')" placeholder="Escribe tu respuesta aqu칤..."></textarea>
                    </div>`;
                }
            });

            return html;
        }

        // --- 6. GESTOR DE BIBLIA (IFRAME) ---
        const bible = {
            open: (ref) => {
                document.getElementById('bible-modal').style.display = 'flex';
                document.getElementById('bible-header-title').innerText = ref;
                // Usamos BibleGateway en modo m칩vil y versi칩n RVR1960. Es lo m치s seguro.
                const url = `https://www.biblegateway.com/passage/?search=${encodeURIComponent(ref)}&version=RVR1960&interface=print`;
                document.getElementById('bible-frame').src = url;
            }
        };

        // --- 7. GESTOR DE NOTAS (PERSISTENCIA) ---
        const notes = {
            save: (id) => {
                const val = document.getElementById(id).value;
                fbDb.ref(`users/${state.user.uid}/notes/${id}`).set(val);
            },
            load: () => {
                // Buscamos todas las notas que empiecen con el prefijo del d칤a
                const prefix = `note-${state.q}-${state.l}-${state.d}`;
                fbDb.ref(`users/${state.user.uid}/notes`).once('value', s => {
                    const data = s.val();
                    if(data) {
                        Object.keys(data).forEach(key => {
                            if(key.startsWith(prefix)) {
                                const el = document.getElementById(key);
                                if(el) el.value = data[key];
                            }
                        });
                    }
                });
            }
        };

        // --- 8. RESALTADOR ---
        const highlighter = {
            color: (colorName) => {
                // Mapeo de colores a variables CSS
                const colors = {
                    'yellow': 'var(--highlight-yellow)',
                    'green': 'var(--highlight-green)',
                    'blue': 'var(--highlight-blue)',
                    'orange': 'var(--highlight-orange)',
                    'purple': 'var(--highlight-purple)'
                };
                
                // Usamos execCommand porque es la 칰nica forma de que funcione
                // a trav칠s de m칰ltiples etiquetas HTML sin romper el DOM.
                // Aunque es "antiguo", es lo m치s estable para este caso.
                document.designMode = "on";
                document.execCommand("BackColor", false, colors[colorName] || 'yellow');
                document.designMode = "off";
                
                // Limpiar selecci칩n
                window.getSelection().removeAllRanges();
            }
        };

        // --- 9. INTERFAZ ---
        const ui = {
            theme: () => document.body.classList.toggle('dark-mode'),
            font: (v) => {
                const root = document.documentElement;
                const current = parseInt(getComputedStyle(root).getPropertyValue('--font-size') || 20);
                root.style.setProperty('--font-size', (current + v) + 'px');
            }
        };
    </script>
</body>
</html>
